// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© Alexandro Disla - GRA DeepFlow Zones (Simplified)
// Horizontal Limit Order Zones | FVG + Single Prints with Lines

//@version=6
indicator("GRA - DeepFlow Zones", shorttitle="DFZ", overlay=true, 
     max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CONFIGURATION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

string GRP_ZONES = "â•â•â•â•â•â•â•â•â•â•â• ZONES â•â•â•â•â•â•â•â•â•â•â•"
bool showZones = input.bool(true, "Show Limit Order Zones", group=GRP_ZONES)
bool showSinglePrintLines = input.bool(true, "Show Single Print Lines", group=GRP_ZONES)
bool requireVolume = input.bool(true, "Require Volume Confirmation", group=GRP_ZONES)
float volMultiplier = input.float(1.3, "Volume Multiplier", minval=1.0, maxval=2.5, step=0.1, group=GRP_ZONES)
int maxZoneAge = input.int(100, "Max Zone Age (bars)", minval=20, maxval=300, group=GRP_ZONES)
int maxZones = input.int(20, "Max Active Zones", minval=5, maxval=50, group=GRP_ZONES)

string GRP_DELTA = "â•â•â•â•â•â•â•â•â•â•â• VOLUME DELTA â•â•â•â•â•â•â•â•â•â•â•"
string deltaTimeframe = input.timeframe("1", "Intrabar TF", group=GRP_DELTA)
int volPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group=GRP_DELTA)
float deltaDominance = input.float(0.55, "Delta Dominance %", minval=0.51, maxval=0.70, step=0.01, group=GRP_DELTA)

string GRP_COLORS = "â•â•â•â•â•â•â•â•â•â•â• COLORS â•â•â•â•â•â•â•â•â•â•â•"
color bullZoneColor = input.color(color.new(#00E676, 85), "Bullish Zone", group=GRP_COLORS)
color bearZoneColor = input.color(color.new(#FF5252, 85), "Bearish Zone", group=GRP_COLORS)
color singlePrintColor = input.color(color.new(#FFD700, 30), "Single Print Lines", group=GRP_COLORS)
color entryLineColor = input.color(color.new(#FFFFFF, 50), "Entry Line (CE)", group=GRP_COLORS)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CORE CALCULATIONS  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

float avgVol = ta.sma(volume, volPeriod)
float avgRange = ta.sma(high - low, volPeriod)
float volRatio = avgVol > 0 ? volume / avgVol : 1.0

float bodySize = math.abs(close - open)
float candleRange = high - low
bool isBullish = close > open
bool isBearish = close < open

// Single Print = Impulse candle (institutional move)
bool isSinglePrint = candleRange > avgRange * 1.5 and bodySize > candleRange * 0.6

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  INTRABAR DELTA ANALYSIS  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float buyVol = 0.0
var float sellVol = 0.0
var float cvd = 0.0

if timeframe.isintraday
    [ltfO, ltfC, ltfV, ltfH, ltfL] = request.security_lower_tf(syminfo.tickerid, deltaTimeframe, [open, close, volume, high, low])
    
    if array.size(ltfC) > 0
        float tBuy = 0.0
        float tSell = 0.0
        
        for i = 0 to array.size(ltfC) - 1
            float r = array.get(ltfH, i) - array.get(ltfL, i)
            float c = array.get(ltfC, i)
            float o = array.get(ltfO, i)
            float v = array.get(ltfV, i)
            
            if r > 0
                float buyPctCalc = (c - array.get(ltfL, i)) / r
                tBuy += buyPctCalc * v
                tSell += (1 - buyPctCalc) * v
            else
                if c >= o
                    tBuy += v
                else
                    tSell += v
        
        buyVol := tBuy
        sellVol := tSell
    else
        float closePos = candleRange > 0 ? (close - low) / candleRange : 0.5
        buyVol := closePos * volume
        sellVol := (1 - closePos) * volume
else
    float closePos = candleRange > 0 ? (close - low) / candleRange : 0.5
    buyVol := closePos * volume
    sellVol := (1 - closePos) * volume

cvd := cvd + (buyVol - sellVol)

float totalVol = buyVol + sellVol
float buyPct = totalVol > 0 ? buyVol / totalVol : 0.5
float sellPct = totalVol > 0 ? sellVol / totalVol : 0.5

bool buyDominant = buyPct >= deltaDominance
bool sellDominant = sellPct >= deltaDominance

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  FVG ZONE DETECTION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// FVG = Fair Value Gap (imbalance zone)
bool fvgBull = low > high[2]  // Gap up: current low above 2-bars-ago high
bool fvgBear = high < low[2]  // Gap down: current high below 2-bars-ago low

bool volConfirmed = not requireVolume or (volume[1] > avgVol * volMultiplier)

bool validBullZone = fvgBull and volConfirmed
bool validBearZone = fvgBear and volConfirmed

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE STORAGE (Arrays)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box[] zoneBoxes = array.new_box(0)
var line[] zoneLines = array.new_line(0)  // CE lines
var bool[] zoneBull = array.new_bool(0)
var float[] zoneTop = array.new_float(0)
var float[] zoneBottom = array.new_float(0)
var int[] zoneBar = array.new_int(0)
var int[] zoneState = array.new_int(0)  // 0=fresh, 1=tested, 2=filled

// Single Print Lines storage
var line[] spHighLines = array.new_line(0)
var line[] spLowLines = array.new_line(0)
var int[] spBars = array.new_int(0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CREATE NEW ZONES  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if showZones
    // Bullish Zone (buy zone below price)
    if validBullZone
        float topPrice = low
        float bottomPrice = high[2]
        float entry = (topPrice + bottomPrice) / 2
        
        // Horizontal box extending far right
        box zoneBox = box.new(bar_index[2], topPrice, bar_index + 500, bottomPrice,
             border_color=color.new(#00E676, 60), bgcolor=bullZoneColor, border_width=1)
        
        // CE entry line
        line entryLine = line.new(bar_index[2], entry, bar_index + 500, entry,
             color=entryLineColor, style=line.style_dotted, width=1)
        
        array.push(zoneBoxes, zoneBox)
        array.push(zoneLines, entryLine)
        array.push(zoneBull, true)
        array.push(zoneTop, topPrice)
        array.push(zoneBottom, bottomPrice)
        array.push(zoneBar, bar_index)
        array.push(zoneState, 0)
    
    // Bearish Zone (sell zone above price)
    if validBearZone
        float topPrice = low[2]
        float bottomPrice = high
        float entry = (topPrice + bottomPrice) / 2
        
        // Horizontal box extending far right
        box zoneBox = box.new(bar_index[2], topPrice, bar_index + 500, bottomPrice,
             border_color=color.new(#FF5252, 60), bgcolor=bearZoneColor, border_width=1)
        
        // CE entry line
        line entryLine = line.new(bar_index[2], entry, bar_index + 500, entry,
             color=entryLineColor, style=line.style_dotted, width=1)
        
        array.push(zoneBoxes, zoneBox)
        array.push(zoneLines, entryLine)
        array.push(zoneBull, false)
        array.push(zoneTop, topPrice)
        array.push(zoneBottom, bottomPrice)
        array.push(zoneBar, bar_index)
        array.push(zoneState, 0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  SINGLE PRINT LINES  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if showSinglePrintLines and isSinglePrint
    // Draw horizontal lines at high and low of single print candle
    line highLine = line.new(bar_index, high, bar_index + 500, high,
         color=singlePrintColor, style=line.style_solid, width=2)
    line lowLine = line.new(bar_index, low, bar_index + 500, low,
         color=singlePrintColor, style=line.style_solid, width=2)
    
    array.push(spHighLines, highLine)
    array.push(spLowLines, lowLine)
    array.push(spBars, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE STATE MANAGEMENT  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Update zone states and clean old zones
if array.size(zoneBoxes) > 0
    for i = array.size(zoneBoxes) - 1 to 0
        int age = bar_index - array.get(zoneBar, i)
        
        // Delete old zones
        if age > maxZoneAge
            box.delete(array.get(zoneBoxes, i))
            line.delete(array.get(zoneLines, i))
            array.remove(zoneBoxes, i)
            array.remove(zoneLines, i)
            array.remove(zoneBull, i)
            array.remove(zoneTop, i)
            array.remove(zoneBottom, i)
            array.remove(zoneBar, i)
            array.remove(zoneState, i)
            continue
        
        float top = array.get(zoneTop, i)
        float bot = array.get(zoneBottom, i)
        bool bull = array.get(zoneBull, i)
        int state = array.get(zoneState, i)
        
        // Check if zone is tested or filled
        if bull
            if state == 0 and low <= (top + bot) / 2
                array.set(zoneState, i, 1)  // Tested
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(#78909C, 85))
            if state < 2 and close < bot
                array.set(zoneState, i, 2)  // Filled
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(color.gray, 92))
        else
            if state == 0 and high >= (top + bot) / 2
                array.set(zoneState, i, 1)  // Tested
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(#78909C, 85))
            if state < 2 and close > top
                array.set(zoneState, i, 2)  // Filled
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(color.gray, 92))

// Clean old single print lines
if array.size(spBars) > 0
    for i = array.size(spBars) - 1 to 0
        int age = bar_index - array.get(spBars, i)
        if age > maxZoneAge
            line.delete(array.get(spHighLines, i))
            line.delete(array.get(spLowLines, i))
            array.remove(spHighLines, i)
            array.remove(spLowLines, i)
            array.remove(spBars, i)

// Garbage collection - limit zones
while array.size(zoneBoxes) > maxZones
    box.delete(array.get(zoneBoxes, 0))
    line.delete(array.get(zoneLines, 0))
    array.remove(zoneBoxes, 0)
    array.remove(zoneLines, 0)
    array.remove(zoneBull, 0)
    array.remove(zoneTop, 0)
    array.remove(zoneBottom, 0)
    array.remove(zoneBar, 0)
    array.remove(zoneState, 0)

// Limit single print lines
while array.size(spBars) > maxZones
    line.delete(array.get(spHighLines, 0))
    line.delete(array.get(spLowLines, 0))
    array.remove(spHighLines, 0)
    array.remove(spLowLines, 0)
    array.remove(spBars, 0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE ENTRY DETECTION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool atBullZone = false
var bool atBearZone = false

atBullZone := false
atBearZone := false

if array.size(zoneBoxes) > 0
    for i = 0 to array.size(zoneBoxes) - 1
        if array.get(zoneState, i) >= 2
            continue
        
        float top = array.get(zoneTop, i)
        float bot = array.get(zoneBottom, i)
        bool bull = array.get(zoneBull, i)
        
        if bull and close >= bot and close <= top
            atBullZone := true
        if not bull and close >= bot and close <= top
            atBearZone := true

bool bullZoneEntry = atBullZone and buyDominant and volRatio > 1.0
bool bearZoneEntry = atBearZone and sellDominant and volRatio > 1.0

// Entry signals
plotshape(bullZoneEntry, "Buy Zone", shape.labelup, location.belowbar, 
     color.new(#00E676, 0), text="BUY", textcolor=color.white, size=size.tiny)
plotshape(bearZoneEntry, "Sell Zone", shape.labeldown, location.abovebar, 
     color.new(#FF5252, 0), text="SELL", textcolor=color.white, size=size.tiny)

// Single print marker
plotshape(isSinglePrint and isBullish, "SP Bull", shape.circle, location.belowbar, 
     color.new(#FFD700, 0), size=size.tiny)
plotshape(isSinglePrint and isBearish, "SP Bear", shape.circle, location.abovebar, 
     color.new(#FFD700, 0), size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  INFO TABLE  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table infoPanel = table.new(position.bottom_right, 2, 6, 
     bgcolor=color.new(#000000, 5), border_width=1, border_color=color.new(#333333, 0))

if barstate.islast
    int bullCount = 0
    int bearCount = 0
    
    if array.size(zoneBull) > 0
        for i = 0 to array.size(zoneBull) - 1
            if array.get(zoneState, i) < 2
                if array.get(zoneBull, i)
                    bullCount += 1
                else
                    bearCount += 1
    
    table.cell(infoPanel, 0, 0, "DFZ", text_color=color.white, text_size=size.small, bgcolor=color.new(#9C27B0, 30))
    table.cell(infoPanel, 1, 0, "ZONES", text_color=color.white, text_size=size.small, bgcolor=color.new(#9C27B0, 30))
    
    string deltaStr = buyPct > sellPct ? str.tostring(buyPct * 100, "#") + "%B" : str.tostring(sellPct * 100, "#") + "%S"
    color deltaCol = buyDominant ? color.new(#00E676, 0) : sellDominant ? color.new(#FF5252, 0) : color.white
    table.cell(infoPanel, 0, 1, "Delta", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 1, deltaStr, text_color=deltaCol, text_size=size.tiny)
    
    string volStr = str.tostring(volRatio, "#.#") + "x"
    color volCol = volRatio > 1.3 ? color.new(#00E676, 0) : color.white
    table.cell(infoPanel, 0, 2, "Vol", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 2, volStr, text_color=volCol, text_size=size.tiny)
    
    table.cell(infoPanel, 0, 3, "Buy â¬š", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 3, str.tostring(bullCount), text_color=color.new(#00E676, 0), text_size=size.tiny)
    
    table.cell(infoPanel, 0, 4, "Sell â¬š", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 4, str.tostring(bearCount), text_color=color.new(#FF5252, 0), text_size=size.tiny)
    
    string zoneStatus = atBullZone ? "AT BUY" : atBearZone ? "AT SELL" : "---"
    color zoneCol = atBullZone ? color.new(#00E676, 0) : atBearZone ? color.new(#FF5252, 0) : color.white
    table.cell(infoPanel, 0, 5, "Zone", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 5, zoneStatus, text_color=zoneCol, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ALERTS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(bullZoneEntry, title="BUY ZONE ENTRY", message="ğŸŸ¢ BUY ZONE {{ticker}} @ {{close}}")
alertcondition(bearZoneEntry, title="SELL ZONE ENTRY", message="ğŸ”´ SELL ZONE {{ticker}} @ {{close}}")
alertcondition(validBullZone, title="NEW BULL ZONE", message="ğŸŸ© NEW BULLISH ZONE {{ticker}}")
alertcondition(validBearZone, title="NEW BEAR ZONE", message="ğŸŸ¥ NEW BEARISH ZONE {{ticker}}")
alertcondition(isSinglePrint, title="SINGLE PRINT", message="â­ SINGLE PRINT {{ticker}} @ {{close}}")

if bullZoneEntry
    alert("DFZ BUY | " + syminfo.ticker + " @ " + str.tostring(close, format.mintick) + " | Delta: " + str.tostring(buyPct * 100, "#") + "%B", alert.freq_once_per_bar_close)

if bearZoneEntry
    alert("DFZ SELL | " + syminfo.ticker + " @ " + str.tostring(close, format.mintick) + " | Delta: " + str.tostring(sellPct * 100, "#") + "%S", alert.freq_once_per_bar_close)
