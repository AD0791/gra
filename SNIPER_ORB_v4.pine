//@version=6
indicator("SNIPER ORB V4.3", shorttitle="SNIPER ORB V4.3", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SNIPER ORB V4.3 - ENHANCED ZONE MANAGEMENT
// 
// IMPROVEMENTS FROM V4.2:
// - DST-aware session detection (adjusts for Daylight Savings Time)
// - Improved zone removal: FVG/iFVG/S&D zones removed when price completely passes through
// - Enhanced iFVG detection with consistent removal logic
// - Better "body-through-body" invalidation (no wicks counted)
// - Optimized for high-volatile futures (NQ, ES, YM, CL, etc.)
//
// SESSIONS (EST/ET - DST Adjusted):
// - Asian:   6:00 PM - 2:59 AM (Sydney → Hong Kong → Tokyo)
// - London:  3:00 AM - 9:29 AM
// - New York: 9:30 AM - 5:00 PM
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// INPUTS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// ORB Session Selection (for breakout signals)
sessionType = input.string("New York", "ORB Active Session", options=["London", "New York"], group="Session Settings")

// === KILLZONE SETTINGS ===
grpKillzone = "Killzone Settings"
showAsianKZ = input.bool(true, "Show Asian Session (6PM-2:59AM)", group=grpKillzone)
showLondonKZ = input.bool(true, "Show London Session (3AM-9:29AM)", group=grpKillzone)
showNYKZ = input.bool(true, "Show New York Session (9:30AM-5PM)", group=grpKillzone)
showKZLabels = input.bool(true, "Show Session Labels", group=grpKillzone)

// Killzone Colors
colorAsianHigh = input.color(color.new(#FF9800, 30), "Asian High", inline="kz_asian", group="Killzone Colors")
colorAsianLow = input.color(color.new(#FF9800, 30), "Asian Low", inline="kz_asian", group="Killzone Colors")
colorLondonHigh = input.color(color.new(#2196F3, 30), "London High", inline="kz_london", group="Killzone Colors")
colorLondonLow = input.color(color.new(#2196F3, 30), "London Low", inline="kz_london", group="Killzone Colors")
colorNYHigh = input.color(color.new(#4CAF50, 30), "NY High", inline="kz_ny", group="Killzone Colors")
colorNYLow = input.color(color.new(#4CAF50, 30), "NY Low", inline="kz_ny", group="Killzone Colors")
kzLineWidth = input.int(1, "Killzone Line Width", minval=1, maxval=3, group="Killzone Colors")

// ORB Display Toggles
show5minORB = input.bool(true, "Show 5min ORB", group="ORB Display", inline="orb_tog")
show15minORB = input.bool(true, "Show 15min ORB", group="ORB Display", inline="orb_tog")
show30minORB = input.bool(true, "Show 30min ORB", group="ORB Display", inline="orb_tog")

// Target Configuration
numTargets = input.int(3, "Number of Targets", minval=1, maxval=10, group="Target Settings")
targetPct = input.float(50.0, "Target % of 30min Range", minval=10, maxval=200, group="Target Settings") * 0.01

// ORB Line Colors
color5minColor = input.color(color.new(#2196F3, 0), "5min ORB", inline="orb5", group="ORB Colors")
line5minWidth = input.int(3, "", minval=1, maxval=5, inline="orb5", group="ORB Colors")

color15minColor = input.color(color.new(#00BCD4, 0), "15min ORB", inline="orb15", group="ORB Colors")
line15minWidth = input.int(2, "", minval=1, maxval=5, inline="orb15", group="ORB Colors")

color30minColor = input.color(color.new(#9C27B0, 0), "30min ORB", inline="orb30", group="ORB Colors")
line30minWidth = input.int(2, "", minval=1, maxval=5, inline="orb30", group="ORB Colors")

// Target Line Colors
colorTargetUp = input.color(color.new(#4CAF50, 0), "Upside Targets", inline="tgt", group="Target Colors")
colorTargetDown = input.color(color.new(#F44336, 0), "Downside Targets", inline="tgt", group="Target Colors")
targetLineWidth = input.int(1, "Width", minval=1, maxval=3, inline="tgt", group="Target Colors")

// VWAP Settings
showVWAP = input.bool(true, "Show Anchored VWAP", group="VWAP Settings")
vwapColor = input.color(color.new(#FFC107, 0), "VWAP Color", group="VWAP Settings")
vwapWidth = input.int(2, "VWAP Width", minval=1, maxval=5, group="VWAP Settings")

// === FVG & iFVG SETTINGS ===
grpFVG = "FVG & iFVG Settings"
showFVGZones = input.bool(true, "Show FVG Zones", group=grpFVG)
showIFVGZones = input.bool(true, "Show iFVG Zones (Inverse)", group=grpFVG)
fvgMinATRMult = input.float(0.3, "FVG Min Size (ATR Multiplier)", minval=0.1, maxval=2.0, step=0.1, group=grpFVG,
    tooltip="Minimum FVG size relative to ATR for volatile markets")
maxFVGCount = input.int(10, "Max FVG Zones", minval=5, maxval=30, group=grpFVG)
fvgExtendBars = input.int(50, "FVG Extend Bars", minval=20, maxval=200, group=grpFVG)

// === SUPPLY & DEMAND SETTINGS ===
grpSD = "Supply & Demand Zones"
showSupplyDemand = input.bool(true, "Show Supply/Demand Zones", group=grpSD)
sdSwingLookback = input.int(5, "Swing Lookback", minval=2, maxval=20, group=grpSD,
    tooltip="Bars to look back for swing highs/lows")
sdMinStrength = input.int(2, "Min Zone Strength", minval=1, maxval=5, group=grpSD,
    tooltip="Minimum touches/rejections for valid zone")
sdATRMultiplier = input.float(0.5, "Zone Size (ATR Mult)", minval=0.2, maxval=2.0, step=0.1, group=grpSD)
maxSDZones = input.int(8, "Max S/D Zones", minval=4, maxval=20, group=grpSD)
sdExtendBars = input.int(100, "S/D Extend Bars", minval=20, maxval=300, group=grpSD)

// === ZONE REMOVAL SETTINGS ===
grpRemoval = "Zone Removal Settings"
removeMitigatedFVG = input.bool(true, "Remove Filled FVG Zones", group=grpRemoval)
removeMitigatedSD = input.bool(true, "Remove Invalidated S/D Zones", group=grpRemoval)

// === CONFIRMATION SETTINGS ===
grpConfirm = "Confirmation Settings"
showConfirmationSignals = input.bool(true, "Show Breakout Confirmation Signals", group=grpConfirm)
showRetestSignals = input.bool(true, "Show Retest Entry Signals", group=grpConfirm)
highlightConfirmCandles = input.bool(true, "Highlight Confirmation Candles", group=grpConfirm)

minVolumeMultiplier = input.float(1.2, "Min Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group=grpConfirm,
    tooltip="Breakout volume must be this times the average (lowered for volatile markets)")
minBodyPercent = input.float(55.0, "Min Body % for Confirmation", minval=40, maxval=85, step=5, group=grpConfirm,
    tooltip="Candle body must be this % of total range")

// Zone Colors
colorFVGBullish = input.color(color.new(#00E676, 80), "Bullish FVG Zone", group="Zone Colors")
colorFVGBearish = input.color(color.new(#FF5252, 80), "Bearish FVG Zone", group="Zone Colors")
colorIFVGBullish = input.color(color.new(#64FFDA, 85), "Bullish iFVG Zone", group="Zone Colors")
colorIFVGBearish = input.color(color.new(#FF80AB, 85), "Bearish iFVG Zone", group="Zone Colors")
colorSupplyZone = input.color(color.new(#E91E63, 85), "Supply Zone", group="Zone Colors")
colorDemandZone = input.color(color.new(#00BCD4, 85), "Demand Zone", group="Zone Colors")

// Confirmation Colors
colorBullishConfirm = input.color(color.new(#00E676, 0), "Bullish Confirm", group="Confirmation Colors")
colorBearishConfirm = input.color(color.new(#FF5252, 0), "Bearish Confirm", group="Confirmation Colors")

// Text Size
txtSize = input.string("Small", "Label Size", options=["Tiny","Small","Normal","Large"], group="Display Settings")
txtSizeFormat = txtSize == "Tiny" ? size.tiny : txtSize == "Small" ? size.small : txtSize == "Normal" ? size.normal : size.large

// Label Overlap Tolerance
labelTolerance = input.float(2.0, "Label Overlap Tolerance (ticks)", minval=0.5, maxval=10, group="Display Settings")

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SESSION DETECTION & KILLZONES (DST-AWARE)
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

string tz = "America/New_York"

// === DST (DAYLIGHT SAVINGS TIME) DETECTION ===
// Automatically adjusts session times based on current DST status
// US DST: 2nd Sunday of March to 1st Sunday of November
// UK DST: Last Sunday of March to Last Sunday of October
// Sydney DST: 1st Sunday of October to 1st Sunday of April (Southern Hemisphere - reversed)
int previousSunday = dayofmonth - dayofweek + 1
bool nyDST = false
bool ukDST = false
bool sydDST = false

if month < 3 or month > 11
    nyDST := false
    ukDST := false
    sydDST := true
else if month > 4 and month < 10
    nyDST := true
    ukDST := true
    sydDST := false
else if month == 3
    nyDST := previousSunday >= 8
    ukDST := previousSunday >= 24
    sydDST := true
else if month == 4
    nyDST := true
    ukDST := true
    sydDST := previousSunday <= 0
else if month == 10
    nyDST := true
    ukDST := previousSunday <= 24
    sydDST := previousSunday >= 0
else // month == 11
    nyDST := previousSunday <= 0
    ukDST := false
    sydDST := true

// === KILLZONE SESSION DEFINITIONS ===
// Sessions are defined in EST/ET and automatically adjust for DST
// Asian Session: 6:00 PM - 2:59 AM ET (spans midnight, needs special handling)
// We split it: 1800-2359 (evening) and 0000-0259 (early morning)
string asianEveningSpec = "1800-2359:23456"
string asianMorningSpec = "0000-0259:23456"
bool inAsianEvening = not na(time(timeframe.period, asianEveningSpec, tz))
bool inAsianMorning = not na(time(timeframe.period, asianMorningSpec, tz))
bool inAsian = inAsianEvening or inAsianMorning
bool asianStart = inAsian and not inAsian[1]
bool asianEnd = inAsian[1] and not inAsian

// London Session: 3:00 AM - 9:29 AM ET
string londonKZSpec = "0300-0929:23456"
bool inLondonKZ = not na(time(timeframe.period, londonKZSpec, tz))
bool londonKZStart = inLondonKZ and not inLondonKZ[1]
bool londonKZEnd = inLondonKZ[1] and not inLondonKZ

// New York Session: 9:30 AM - 5:00 PM ET
string nyKZSpec = "0930-1700:23456"
bool inNYKZ = not na(time(timeframe.period, nyKZSpec, tz))
bool nyKZStart = inNYKZ and not inNYKZ[1]
bool nyKZEnd = inNYKZ[1] and not inNYKZ

// Daily Reset Detection: 6:00 PM EST (Globex open for new trading day)
int currentHourKZ = hour(time, tz)
int currentMinuteKZ = minute(time, tz)
bool isDailyReset = currentHourKZ == 18 and currentMinuteKZ == 0 and not (hour(time[1], tz) == 18 and minute(time[1], tz) == 0)

// === ORB SESSION DETECTION (for breakout signals) ===
// London for ORB: 3:00 AM - 9:30 AM ET
string londonSpec = "0300-0930:23456"
bool inLondon = not na(time(timeframe.period, londonSpec, tz))
bool londonStart = inLondon and not inLondon[1]
bool londonEnd = inLondon[1] and not inLondon

// New York for ORB: 9:30 AM - 5:00 PM ET
string nySpec = "0930-1700:23456"
bool inNY = not na(time(timeframe.period, nySpec, tz))
bool nyStart = inNY and not inNY[1]
bool nyEnd = inNY[1] and not inNY

// Active session based on user selection (for ORB)
bool isActiveSession = sessionType == "London" ? inLondon : inNY
bool isSessionStart = sessionType == "London" ? londonStart : nyStart
bool isSessionEnd = sessionType == "London" ? londonEnd : nyEnd

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// VOLATILITY & VOLUME ANALYSIS (OPTIMIZED FOR FUTURES)
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// ATR for dynamic zone sizing in volatile markets
float atrValue = ta.atr(14)
float avgVolume = ta.sma(volume, 20)
bool isHighVolume = volume >= avgVolume * minVolumeMultiplier

// Volatility expansion detection
float atrSMA = ta.sma(atrValue, 20)
bool isHighVolatility = atrValue > atrSMA * 1.3

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ORB STATE VARIABLES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// 5-minute ORB
var float orb5High = na
var float orb5Low = na
var bool orb5Complete = false
var int orb5StartBar = na

// 15-minute ORB
var float orb15High = na
var float orb15Low = na
var bool orb15Complete = false
var int orb15StartBar = na

// 30-minute ORB
var float orb30High = na
var float orb30Low = na
var bool orb30Complete = false
var int orb30StartBar = na
var float orb30Range = na
var float orb30Mid = na

// Session tracking
var int sessionStartBar = na

// Line objects for ORBs
var line line5High = na
var line line5Low = na
var line line15High = na
var line line15Low = na
var line line30High = na
var line line30Low = na

// SMART LABEL SYSTEM
var label labelHighCombined = na
var label labelLowCombined = na

// Target arrays
var array<line> upTargetLines = array.new<line>()
var array<line> downTargetLines = array.new<line>()
var array<label> upTargetLabels = array.new<label>()
var array<label> downTargetLabels = array.new<label>()

// Breakout Tracking
var bool broke30High = false
var bool broke30Low = false
var int breakoutBar = na
var float breakoutPrice = na

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// KILLZONE STATE VARIABLES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Asian Session High/Low (6PM - 2:59AM EST)
var float asianHigh = na
var float asianLow = na
var int asianStartBar = na
var bool asianComplete = false

// London Session High/Low (3AM - 9:29AM EST)
var float londonKZHigh = na
var float londonKZLow = na
var int londonKZStartBar = na
var bool londonKZComplete = false

// New York Session High/Low (9:30AM - 5PM EST)
var float nyKZHigh = na
var float nyKZLow = na
var int nyKZStartBar = na
var bool nyKZComplete = false

// Killzone Line Objects
var line lineAsianHigh = na
var line lineAsianLow = na
var line lineLondonKZHigh = na
var line lineLondonKZLow = na
var line lineNYKZHigh = na
var line lineNYKZLow = na

// Killzone Labels
var label labelAsianHigh = na
var label labelAsianLow = na
var label labelLondonKZHigh = na
var label labelLondonKZLow = na
var label labelNYKZHigh = na
var label labelNYKZLow = na

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// FVG & iFVG TRACKING STRUCTURES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// FVG arrays - store zone data
var array<box> fvgBoxes = array.new<box>()
var array<float> fvgHighs = array.new<float>()
var array<float> fvgLows = array.new<float>()
var array<bool> fvgBullish = array.new<bool>()
var array<int> fvgStartBars = array.new<int>()

// iFVG arrays (Inverse FVGs - gaps filled against the trend)
var array<box> ifvgBoxes = array.new<box>()
var array<float> ifvgHighs = array.new<float>()
var array<float> ifvgLows = array.new<float>()
var array<bool> ifvgBullish = array.new<bool>()
var array<int> ifvgStartBars = array.new<int>()

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SUPPLY & DEMAND ZONE STRUCTURES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

var array<box> supplyBoxes = array.new<box>()
var array<float> supplyHighs = array.new<float>()
var array<float> supplyLows = array.new<float>()
var array<int> supplyStartBars = array.new<int>()
var array<int> supplyTouches = array.new<int>()

var array<box> demandBoxes = array.new<box>()
var array<float> demandHighs = array.new<float>()
var array<float> demandLows = array.new<float>()
var array<int> demandStartBars = array.new<int>()
var array<int> demandTouches = array.new<int>()

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// CANDLE ANALYSIS FUNCTIONS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

getCandleMetrics() =>
    float candleRange = high - low
    float bodySize = math.abs(close - open)
    float upperWick = high - math.max(close, open)
    float lowerWick = math.min(close, open) - low
    float bodyPct = candleRange > 0 ? (bodySize / candleRange) * 100 : 0
    float upperWickPct = candleRange > 0 ? (upperWick / candleRange) * 100 : 0
    float lowerWickPct = candleRange > 0 ? (lowerWick / candleRange) * 100 : 0
    [bodyPct, upperWickPct, lowerWickPct, bodySize, candleRange]

[bodyPercent, upperWickPct, lowerWickPct, bodySize, candleRange] = getCandleMetrics()

// Momentum candle detection - optimized for volatile futures
isBullishMomentum() =>
    bool isBullish = close > open
    bool strongBody = bodyPercent >= minBodyPercent
    bool minimalUpperWick = upperWickPct <= 30  // Slightly relaxed for volatile markets
    isBullish and strongBody and minimalUpperWick

isBearishMomentum() =>
    bool isBearish = close < open
    bool strongBody = bodyPercent >= minBodyPercent
    bool minimalLowerWick = lowerWickPct <= 30
    isBearish and strongBody and minimalLowerWick

// Engulfing patterns
isBullishEngulfing() =>
    bool prevBearish = close[1] < open[1]
    bool currBullish = close > open
    bool engulfsBody = close > open[1] and open <= close[1]
    bool strongCurrent = bodyPercent >= 45
    prevBearish and currBullish and engulfsBody and strongCurrent

isBearishEngulfing() =>
    bool prevBullish = close[1] > open[1]
    bool currBearish = close < open
    bool engulfsBody = close < open[1] and open >= close[1]
    bool strongCurrent = bodyPercent >= 45
    prevBullish and currBearish and engulfsBody and strongCurrent

// Reversal patterns
isHammer() =>
    bool smallBody = bodyPercent <= 40
    bool longLowerWick = lowerWickPct >= 50
    bool tinyUpperWick = upperWickPct <= 15
    smallBody and longLowerWick and tinyUpperWick

isShootingStar() =>
    bool smallBody = bodyPercent <= 40
    bool longUpperWick = upperWickPct >= 50
    bool tinyLowerWick = lowerWickPct <= 15
    smallBody and longUpperWick and tinyLowerWick

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// FVG DETECTION - ATR-BASED FOR VOLATILE MARKETS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Minimum gap size based on ATR for volatile markets
float minFVGSize = atrValue * fvgMinATRMult

// Bullish FVG: Gap between candle[2] high and candle[0] low (price gapped up)
detectBullishFVG() =>
    float gapSize = low - high[2]
    bool hasGap = gapSize > 0
    bool significantGap = gapSize >= minFVGSize
    bool isBullishMove = close > close[2] and close > open
    [hasGap and significantGap and isBullishMove, high[2], low, gapSize]

// Bearish FVG: Gap between candle[0] high and candle[2] low (price gapped down)
detectBearishFVG() =>
    float gapSize = low[2] - high
    bool hasGap = gapSize > 0
    bool significantGap = gapSize >= minFVGSize
    bool isBearishMove = close < close[2] and close < open
    [hasGap and significantGap and isBearishMove, high, low[2], gapSize]

// iFVG Detection (Inverse FVG - gaps that occur against the prevailing momentum)
// Bullish iFVG: Gap down in an uptrend (potential support)
detectBullishIFVG() =>
    float gapSize = low[2] - high
    bool hasGap = gapSize > 0
    bool significantGap = gapSize >= minFVGSize * 0.7  // Slightly smaller threshold
    bool uptrendContext = close > ta.sma(close, 10)
    bool isExhaustionGap = close > open  // Recovered
    [hasGap and significantGap and uptrendContext and isExhaustionGap, high, low[2], gapSize]

// Bearish iFVG: Gap up in a downtrend (potential resistance)
detectBearishIFVG() =>
    float gapSize = low - high[2]
    bool hasGap = gapSize > 0
    bool significantGap = gapSize >= minFVGSize * 0.7
    bool downtrendContext = close < ta.sma(close, 10)
    bool isExhaustionGap = close < open  // Rejected
    [hasGap and significantGap and downtrendContext and isExhaustionGap, high[2], low, gapSize]

[hasBullishFVG, bullFVGLow, bullFVGHigh, bullFVGSize] = detectBullishFVG()
[hasBearishFVG, bearFVGHigh, bearFVGLow, bearFVGSize] = detectBearishFVG()
[hasBullishIFVG, bullIFVGHigh, bullIFVGLow, bullIFVGSize] = detectBullishIFVG()
[hasBearishIFVG, bearIFVGHigh, bearIFVGLow, bearIFVGSize] = detectBearishIFVG()

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SUPPLY & DEMAND ZONE DETECTION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Swing High Detection (potential Supply Zone origin)
isSwingHigh = ta.pivothigh(high, sdSwingLookback, sdSwingLookback) != 0

// Swing Low Detection (potential Demand Zone origin)  
isSwingLow = ta.pivotlow(low, sdSwingLookback, sdSwingLookback) != 0

// Strong bearish move from swing high (Supply Zone)
isStrongBearishMove() =>
    bool strongDrop = close < close[sdSwingLookback]
    bool momentumConfirm = close < open and bodyPercent >= 40
    strongDrop and momentumConfirm

// Strong bullish move from swing low (Demand Zone)
isStrongBullishMove() =>
    bool strongRise = close > close[sdSwingLookback]
    bool momentumConfirm = close > open and bodyPercent >= 40
    strongRise and momentumConfirm

// Zone size based on ATR
float zoneSize = atrValue * sdATRMultiplier

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ZONE MITIGATION CHECK - ENHANCED BODY-THROUGH-BODY DETECTION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Check if a zone has been COMPLETELY passed through (body-through-body, NOT wicks)
// This is the strictest check - the entire candle body must be BEYOND the zone
// For bullish zones: price must close completely BELOW zone (bearish invalidation)
// For bearish zones: price must close completely ABOVE zone (bullish invalidation)

// Primary function: Check if candle body has completely passed through the zone
isBodyCompletelyThrough(float zoneHigh, float zoneLow, bool isBullishZone) =>
    float bodyTop = math.max(open, close)
    float bodyBottom = math.min(open, close)
    
    if isBullishZone
        // For bullish zones (demand/bullish FVG/bullish iFVG):
        // Zone invalidated when candle body is ENTIRELY below zone low
        // Both open and close must be below zone low (bearish move through zone)
        bool bodyBelowZone = bodyTop < zoneLow
        bodyBelowZone
    else
        // For bearish zones (supply/bearish FVG/bearish iFVG):
        // Zone invalidated when candle body is ENTIRELY above zone high
        // Both open and close must be above zone high (bullish move through zone)
        bool bodyAboveZone = bodyBottom > zoneHigh
        bodyAboveZone

// Secondary check: Has price traded completely through on ANY bar since zone creation
// This is used in the loop to check historical price action
isPriceCompletelyThrough(float zoneHigh, float zoneLow, bool isBullishZone) =>
    float bodyTop = math.max(open, close)
    float bodyBottom = math.min(open, close)
    
    if isBullishZone
        // Bullish zone invalidated: body completely below zone low
        bool completelyBelow = bodyTop < zoneLow
        completelyBelow
    else
        // Bearish zone invalidated: body completely above zone high  
        bool completelyAbove = bodyBottom > zoneHigh
        completelyAbove

// Additional check: Zone partially filled (for potential future use)
isZonePartiallyFilled(float zoneHigh, float zoneLow, bool isBullishZone) =>
    if isBullishZone
        // Check if price wicked into zone but didn't pass through
        bool wickedIn = low <= zoneHigh and close > zoneLow
        wickedIn
    else
        bool wickedIn = high >= zoneLow and close < zoneHigh
        wickedIn

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// FVG ZONE MANAGEMENT - CREATE & REMOVE
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Remove oldest FVG if limit reached
removeOldestFVG() =>
    if array.size(fvgBoxes) > maxFVGCount
        box oldBox = array.shift(fvgBoxes)
        box.delete(oldBox)
        array.shift(fvgHighs)
        array.shift(fvgLows)
        array.shift(fvgBullish)
        array.shift(fvgStartBars)

removeOldestIFVG() =>
    if array.size(ifvgBoxes) > maxFVGCount
        box oldBox = array.shift(ifvgBoxes)
        box.delete(oldBox)
        array.shift(ifvgHighs)
        array.shift(ifvgLows)
        array.shift(ifvgBullish)
        array.shift(ifvgStartBars)

// Check and remove filled FVG zones (body-through-body removal)
checkAndRemoveFVGs() =>
    if removeMitigatedFVG and array.size(fvgBoxes) > 0
        // Iterate backwards to safely remove elements
        for i = array.size(fvgBoxes) - 1 to 0
            if i >= 0 and i < array.size(fvgBoxes)
                float zHigh = array.get(fvgHighs, i)
                float zLow = array.get(fvgLows, i)
                bool isBull = array.get(fvgBullish, i)
                
                // Check if candle body has completely passed through zone
                // Bullish FVG: invalidated when body trades entirely BELOW zone
                // Bearish FVG: invalidated when body trades entirely ABOVE zone
                if isBodyCompletelyThrough(zHigh, zLow, isBull)
                    box bx = array.get(fvgBoxes, i)
                    box.delete(bx)
                    array.remove(fvgBoxes, i)
                    array.remove(fvgHighs, i)
                    array.remove(fvgLows, i)
                    array.remove(fvgBullish, i)
                    array.remove(fvgStartBars, i)

// Check and remove filled iFVG zones (same body-through-body logic)
// iFVG removal is consistent with FVG - when price passes completely through
checkAndRemoveIFVGs() =>
    if removeMitigatedFVG and array.size(ifvgBoxes) > 0
        for i = array.size(ifvgBoxes) - 1 to 0
            if i >= 0 and i < array.size(ifvgBoxes)
                float zHigh = array.get(ifvgHighs, i)
                float zLow = array.get(ifvgLows, i)
                bool isBull = array.get(ifvgBullish, i)
                
                // iFVG removal: same logic as FVG
                // Bullish iFVG (gap down in uptrend): invalidated when body below zone
                // Bearish iFVG (gap up in downtrend): invalidated when body above zone
                if isBodyCompletelyThrough(zHigh, zLow, isBull)
                    box bx = array.get(ifvgBoxes, i)
                    box.delete(bx)
                    array.remove(ifvgBoxes, i)
                    array.remove(ifvgHighs, i)
                    array.remove(ifvgLows, i)
                    array.remove(ifvgBullish, i)
                    array.remove(ifvgStartBars, i)

// Create FVG zones
if isActiveSession and showFVGZones
    // Bullish FVG
    if hasBullishFVG
        box fvgBox = box.new(bar_index - 2, bullFVGHigh, bar_index + fvgExtendBars, bullFVGLow, 
                             border_color=color.new(colorFVGBullish, 50), bgcolor=colorFVGBullish,
                             border_width=1, border_style=line.style_solid)
        array.push(fvgBoxes, fvgBox)
        array.push(fvgHighs, bullFVGHigh)
        array.push(fvgLows, bullFVGLow)
        array.push(fvgBullish, true)
        array.push(fvgStartBars, bar_index)
        removeOldestFVG()
    
    // Bearish FVG
    if hasBearishFVG
        box fvgBox = box.new(bar_index - 2, bearFVGHigh, bar_index + fvgExtendBars, bearFVGLow, 
                             border_color=color.new(colorFVGBearish, 50), bgcolor=colorFVGBearish,
                             border_width=1, border_style=line.style_solid)
        array.push(fvgBoxes, fvgBox)
        array.push(fvgHighs, bearFVGHigh)
        array.push(fvgLows, bearFVGLow)
        array.push(fvgBullish, false)
        array.push(fvgStartBars, bar_index)
        removeOldestFVG()

// Create iFVG zones
if isActiveSession and showIFVGZones
    // Bullish iFVG (support in uptrend)
    if hasBullishIFVG
        box ifvgBox = box.new(bar_index - 2, bullIFVGHigh, bar_index + fvgExtendBars, bullIFVGLow, 
                              border_color=color.new(colorIFVGBullish, 40), bgcolor=colorIFVGBullish,
                              border_width=1, border_style=line.style_dashed)
        array.push(ifvgBoxes, ifvgBox)
        array.push(ifvgHighs, bullIFVGHigh)
        array.push(ifvgLows, bullIFVGLow)
        array.push(ifvgBullish, true)
        array.push(ifvgStartBars, bar_index)
        removeOldestIFVG()
    
    // Bearish iFVG (resistance in downtrend)
    if hasBearishIFVG
        box ifvgBox = box.new(bar_index - 2, bearIFVGHigh, bar_index + fvgExtendBars, bearIFVGLow, 
                              border_color=color.new(colorIFVGBearish, 40), bgcolor=colorIFVGBearish,
                              border_width=1, border_style=line.style_dashed)
        array.push(ifvgBoxes, ifvgBox)
        array.push(ifvgHighs, bearIFVGHigh)
        array.push(ifvgLows, bearIFVGLow)
        array.push(ifvgBullish, false)
        array.push(ifvgStartBars, bar_index)
        removeOldestIFVG()

// Check and remove filled zones every bar
checkAndRemoveFVGs()
checkAndRemoveIFVGs()

// Extend existing FVG boxes
if array.size(fvgBoxes) > 0
    for i = 0 to array.size(fvgBoxes) - 1
        if i < array.size(fvgBoxes)
            box bx = array.get(fvgBoxes, i)
            box.set_right(bx, bar_index + fvgExtendBars)

if array.size(ifvgBoxes) > 0
    for i = 0 to array.size(ifvgBoxes) - 1
        if i < array.size(ifvgBoxes)
            box bx = array.get(ifvgBoxes, i)
            box.set_right(bx, bar_index + fvgExtendBars)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SUPPLY & DEMAND ZONE MANAGEMENT
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

removeOldestSupply() =>
    if array.size(supplyBoxes) > maxSDZones
        box oldBox = array.shift(supplyBoxes)
        box.delete(oldBox)
        array.shift(supplyHighs)
        array.shift(supplyLows)
        array.shift(supplyStartBars)
        array.shift(supplyTouches)

removeOldestDemand() =>
    if array.size(demandBoxes) > maxSDZones
        box oldBox = array.shift(demandBoxes)
        box.delete(oldBox)
        array.shift(demandHighs)
        array.shift(demandLows)
        array.shift(demandStartBars)
        array.shift(demandTouches)

// Check and remove invalidated S/D zones (body-through-body removal)
checkAndRemoveSupplyZones() =>
    if removeMitigatedSD and array.size(supplyBoxes) > 0
        for i = array.size(supplyBoxes) - 1 to 0
            if i >= 0 and i < array.size(supplyBoxes)
                float zHigh = array.get(supplyHighs, i)
                float zLow = array.get(supplyLows, i)
                
                // Supply zone (bearish zone) invalidated when candle body is entirely ABOVE zone
                // Both open and close must be above zone high (bullish breakthrough)
                if isBodyCompletelyThrough(zHigh, zLow, false)
                    box bx = array.get(supplyBoxes, i)
                    box.delete(bx)
                    array.remove(supplyBoxes, i)
                    array.remove(supplyHighs, i)
                    array.remove(supplyLows, i)
                    array.remove(supplyStartBars, i)
                    array.remove(supplyTouches, i)

checkAndRemoveDemandZones() =>
    if removeMitigatedSD and array.size(demandBoxes) > 0
        for i = array.size(demandBoxes) - 1 to 0
            if i >= 0 and i < array.size(demandBoxes)
                float zHigh = array.get(demandHighs, i)
                float zLow = array.get(demandLows, i)
                
                // Demand zone (bullish zone) invalidated when candle body is entirely BELOW zone
                // Both open and close must be below zone low (bearish breakthrough)
                if isBodyCompletelyThrough(zHigh, zLow, true)
                    box bx = array.get(demandBoxes, i)
                    box.delete(bx)
                    array.remove(demandBoxes, i)
                    array.remove(demandHighs, i)
                    array.remove(demandLows, i)
                    array.remove(demandStartBars, i)
                    array.remove(demandTouches, i)

// Check for zone touches (to track strength)
updateZoneTouches() =>
    // Update supply zone touches
    if array.size(supplyBoxes) > 0
        for i = 0 to array.size(supplyBoxes) - 1
            if i < array.size(supplyBoxes)
                float zHigh = array.get(supplyHighs, i)
                float zLow = array.get(supplyLows, i)
                // Price touched zone (wicked into it)
                if high >= zLow and high <= zHigh and close < zLow
                    array.set(supplyTouches, i, array.get(supplyTouches, i) + 1)
    
    // Update demand zone touches
    if array.size(demandBoxes) > 0
        for i = 0 to array.size(demandBoxes) - 1
            if i < array.size(demandBoxes)
                float zHigh = array.get(demandHighs, i)
                float zLow = array.get(demandLows, i)
                // Price touched zone
                if low <= zHigh and low >= zLow and close > zHigh
                    array.set(demandTouches, i, array.get(demandTouches, i) + 1)

// Create Supply Zone at swing high with strong move down
if isActiveSession and showSupplyDemand and isSwingHigh[sdSwingLookback] and isStrongBearishMove()
    float swingHighPrice = high[sdSwingLookback]
    float zoneTop = swingHighPrice
    float zoneBottom = swingHighPrice - zoneSize
    
    // Check if zone doesn't overlap too much with existing zones
    bool canCreate = true
    if array.size(supplyBoxes) > 0
        for i = 0 to array.size(supplyBoxes) - 1
            if i < array.size(supplyBoxes)
                float existingHigh = array.get(supplyHighs, i)
                float existingLow = array.get(supplyLows, i)
                // Check for significant overlap
                if math.abs(existingHigh - zoneTop) < zoneSize * 0.5
                    canCreate := false
                    break
    
    if canCreate
        box supplyBox = box.new(bar_index - sdSwingLookback, zoneTop, bar_index + sdExtendBars, zoneBottom,
                                border_color=color.new(colorSupplyZone, 30), bgcolor=colorSupplyZone,
                                border_width=2, border_style=line.style_solid)
        array.push(supplyBoxes, supplyBox)
        array.push(supplyHighs, zoneTop)
        array.push(supplyLows, zoneBottom)
        array.push(supplyStartBars, bar_index)
        array.push(supplyTouches, 1)
        removeOldestSupply()

// Create Demand Zone at swing low with strong move up
if isActiveSession and showSupplyDemand and isSwingLow[sdSwingLookback] and isStrongBullishMove()
    float swingLowPrice = low[sdSwingLookback]
    float zoneBottom = swingLowPrice
    float zoneTop = swingLowPrice + zoneSize
    
    bool canCreate = true
    if array.size(demandBoxes) > 0
        for i = 0 to array.size(demandBoxes) - 1
            if i < array.size(demandBoxes)
                float existingLow = array.get(demandLows, i)
                if math.abs(existingLow - zoneBottom) < zoneSize * 0.5
                    canCreate := false
                    break
    
    if canCreate
        box demandBox = box.new(bar_index - sdSwingLookback, zoneTop, bar_index + sdExtendBars, zoneBottom,
                                border_color=color.new(colorDemandZone, 30), bgcolor=colorDemandZone,
                                border_width=2, border_style=line.style_solid)
        array.push(demandBoxes, demandBox)
        array.push(demandHighs, zoneTop)
        array.push(demandLows, zoneBottom)
        array.push(demandStartBars, bar_index)
        array.push(demandTouches, 1)
        removeOldestDemand()

// Update and check zones
checkAndRemoveSupplyZones()
checkAndRemoveDemandZones()
updateZoneTouches()

// Extend S/D boxes
if array.size(supplyBoxes) > 0
    for i = 0 to array.size(supplyBoxes) - 1
        if i < array.size(supplyBoxes)
            box bx = array.get(supplyBoxes, i)
            box.set_right(bx, bar_index + sdExtendBars)

if array.size(demandBoxes) > 0
    for i = 0 to array.size(demandBoxes) - 1
        if i < array.size(demandBoxes)
            box bx = array.get(demandBoxes, i)
            box.set_right(bx, bar_index + sdExtendBars)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// KILLZONE HIGH/LOW TRACKING
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Helper function to delete killzone lines and labels
deleteKillzoneLines() =>
    if not na(lineAsianHigh)
        line.delete(lineAsianHigh)
    if not na(lineAsianLow)
        line.delete(lineAsianLow)
    if not na(lineLondonKZHigh)
        line.delete(lineLondonKZHigh)
    if not na(lineLondonKZLow)
        line.delete(lineLondonKZLow)
    if not na(lineNYKZHigh)
        line.delete(lineNYKZHigh)
    if not na(lineNYKZLow)
        line.delete(lineNYKZLow)
    if not na(labelAsianHigh)
        label.delete(labelAsianHigh)
    if not na(labelAsianLow)
        label.delete(labelAsianLow)
    if not na(labelLondonKZHigh)
        label.delete(labelLondonKZHigh)
    if not na(labelLondonKZLow)
        label.delete(labelLondonKZLow)
    if not na(labelNYKZHigh)
        label.delete(labelNYKZHigh)
    if not na(labelNYKZLow)
        label.delete(labelNYKZLow)

// === DAILY RESET AT 6:00 PM EST (Globex Open) ===
if isDailyReset
    // Reset all killzone levels
    asianHigh := na
    asianLow := na
    asianStartBar := na
    asianComplete := false
    
    londonKZHigh := na
    londonKZLow := na
    londonKZStartBar := na
    londonKZComplete := false
    
    nyKZHigh := na
    nyKZLow := na
    nyKZStartBar := na
    nyKZComplete := false
    
    // Delete old lines
    deleteKillzoneLines()
    
    lineAsianHigh := na
    lineAsianLow := na
    lineLondonKZHigh := na
    lineLondonKZLow := na
    lineNYKZHigh := na
    lineNYKZLow := na
    labelAsianHigh := na
    labelAsianLow := na
    labelLondonKZHigh := na
    labelLondonKZLow := na
    labelNYKZHigh := na
    labelNYKZLow := na

// === ASIAN SESSION HIGH/LOW FORMATION ===
if asianStart
    asianHigh := high
    asianLow := low
    asianStartBar := bar_index
    asianComplete := false

if inAsian and not asianComplete
    if high > asianHigh or na(asianHigh)
        asianHigh := high
    if low < asianLow or na(asianLow)
        asianLow := low

if asianEnd
    asianComplete := true

// === LONDON SESSION HIGH/LOW FORMATION ===
if londonKZStart
    londonKZHigh := high
    londonKZLow := low
    londonKZStartBar := bar_index
    londonKZComplete := false

if inLondonKZ and not londonKZComplete
    if high > londonKZHigh or na(londonKZHigh)
        londonKZHigh := high
    if low < londonKZLow or na(londonKZLow)
        londonKZLow := low

if londonKZEnd
    londonKZComplete := true

// === NEW YORK SESSION HIGH/LOW FORMATION ===
if nyKZStart
    nyKZHigh := high
    nyKZLow := low
    nyKZStartBar := bar_index
    nyKZComplete := false

if inNYKZ and not nyKZComplete
    if high > nyKZHigh or na(nyKZHigh)
        nyKZHigh := high
    if low < nyKZLow or na(nyKZLow)
        nyKZLow := low

if nyKZEnd
    nyKZComplete := true

// === DRAW KILLZONE LINES ===
// Asian Session Lines (dotted, extend through the day)
if showAsianKZ and not na(asianHigh) and not na(asianStartBar)
    if na(lineAsianHigh)
        lineAsianHigh := line.new(asianStartBar, asianHigh, bar_index, asianHigh, 
                                  color=colorAsianHigh, width=kzLineWidth, style=line.style_dotted)
        lineAsianLow := line.new(asianStartBar, asianLow, bar_index, asianLow, 
                                 color=colorAsianLow, width=kzLineWidth, style=line.style_dotted)
    else
        line.set_y1(lineAsianHigh, asianHigh)
        line.set_y2(lineAsianHigh, asianHigh)
        line.set_x2(lineAsianHigh, bar_index)
        line.set_y1(lineAsianLow, asianLow)
        line.set_y2(lineAsianLow, asianLow)
        line.set_x2(lineAsianLow, bar_index)
    
    // Labels
    if showKZLabels
        if not na(labelAsianHigh)
            label.delete(labelAsianHigh)
        if not na(labelAsianLow)
            label.delete(labelAsianLow)
        
        labelAsianHigh := label.new(bar_index, asianHigh, "Asia H", 
                                    style=label.style_label_left, 
                                    color=color.new(color.black, 100), 
                                    textcolor=colorAsianHigh, 
                                    size=size.tiny)
        labelAsianLow := label.new(bar_index, asianLow, "Asia L", 
                                   style=label.style_label_left, 
                                   color=color.new(color.black, 100), 
                                   textcolor=colorAsianLow, 
                                   size=size.tiny)

// London Session Lines
if showLondonKZ and not na(londonKZHigh) and not na(londonKZStartBar)
    if na(lineLondonKZHigh)
        lineLondonKZHigh := line.new(londonKZStartBar, londonKZHigh, bar_index, londonKZHigh, 
                                     color=colorLondonHigh, width=kzLineWidth, style=line.style_dotted)
        lineLondonKZLow := line.new(londonKZStartBar, londonKZLow, bar_index, londonKZLow, 
                                    color=colorLondonLow, width=kzLineWidth, style=line.style_dotted)
    else
        line.set_y1(lineLondonKZHigh, londonKZHigh)
        line.set_y2(lineLondonKZHigh, londonKZHigh)
        line.set_x2(lineLondonKZHigh, bar_index)
        line.set_y1(lineLondonKZLow, londonKZLow)
        line.set_y2(lineLondonKZLow, londonKZLow)
        line.set_x2(lineLondonKZLow, bar_index)
    
    // Labels
    if showKZLabels
        if not na(labelLondonKZHigh)
            label.delete(labelLondonKZHigh)
        if not na(labelLondonKZLow)
            label.delete(labelLondonKZLow)
        
        labelLondonKZHigh := label.new(bar_index, londonKZHigh, "LDN H", 
                                       style=label.style_label_left, 
                                       color=color.new(color.black, 100), 
                                       textcolor=colorLondonHigh, 
                                       size=size.tiny)
        labelLondonKZLow := label.new(bar_index, londonKZLow, "LDN L", 
                                      style=label.style_label_left, 
                                      color=color.new(color.black, 100), 
                                      textcolor=colorLondonLow, 
                                      size=size.tiny)

// New York Session Lines
if showNYKZ and not na(nyKZHigh) and not na(nyKZStartBar)
    if na(lineNYKZHigh)
        lineNYKZHigh := line.new(nyKZStartBar, nyKZHigh, bar_index, nyKZHigh, 
                                 color=colorNYHigh, width=kzLineWidth, style=line.style_dotted)
        lineNYKZLow := line.new(nyKZStartBar, nyKZLow, bar_index, nyKZLow, 
                                color=colorNYLow, width=kzLineWidth, style=line.style_dotted)
    else
        line.set_y1(lineNYKZHigh, nyKZHigh)
        line.set_y2(lineNYKZHigh, nyKZHigh)
        line.set_x2(lineNYKZHigh, bar_index)
        line.set_y1(lineNYKZLow, nyKZLow)
        line.set_y2(lineNYKZLow, nyKZLow)
        line.set_x2(lineNYKZLow, bar_index)
    
    // Labels
    if showKZLabels
        if not na(labelNYKZHigh)
            label.delete(labelNYKZHigh)
        if not na(labelNYKZLow)
            label.delete(labelNYKZLow)
        
        labelNYKZHigh := label.new(bar_index, nyKZHigh, "NY H", 
                                   style=label.style_label_left, 
                                   color=color.new(color.black, 100), 
                                   textcolor=colorNYHigh, 
                                   size=size.tiny)
        labelNYKZLow := label.new(bar_index, nyKZLow, "NY L", 
                                  style=label.style_label_left, 
                                  color=color.new(color.black, 100), 
                                  textcolor=colorNYLow, 
                                  size=size.tiny)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ANCHORED VWAP CALCULATION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

var float vwapSum = 0.0
var float volumeSum = 0.0

int currentHour = hour(time, tz)
int currentMinute = minute(time, tz)

bool isNYStartCandle = sessionType == "New York" and currentHour == 9 and currentMinute == 30 and not (hour(time[1], tz) == 9 and minute(time[1], tz) == 30)
bool isLondonStartCandle = sessionType == "London" and currentHour == 3 and currentMinute == 0 and not (hour(time[1], tz) == 3 and minute(time[1], tz) == 0)
bool isVWAPAnchorCandle = isNYStartCandle or isLondonStartCandle

if isVWAPAnchorCandle
    vwapSum := 0.0
    volumeSum := 0.0

if isActiveSession
    float typicalPrice = hlc3
    vwapSum += typicalPrice * volume
    volumeSum += volume

float vwap = volumeSum > 0 ? vwapSum / volumeSum : na

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SMART LABEL STACKING FUNCTIONS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

tolerancePrice = labelTolerance * syminfo.mintick

buildHighLabel() =>
    string labelText = ""
    color labelColor = color.white
    float labelPrice = na
    
    float h5 = show5minORB and not na(orb5High) ? orb5High : na
    float h15 = show15minORB and not na(orb15High) ? orb15High : na
    float h30 = show30minORB and not na(orb30High) ? orb30High : na
    
    float maxHigh = na
    if not na(h5)
        maxHigh := h5
    if not na(h15)
        maxHigh := na(maxHigh) ? h15 : math.max(maxHigh, h15)
    if not na(h30)
        maxHigh := na(maxHigh) ? h30 : math.max(maxHigh, h30)
    
    labelPrice := maxHigh
    
    if not na(maxHigh)
        if not na(h5) and math.abs(h5 - maxHigh) <= tolerancePrice
            labelText := "5m H"
            labelColor := color5minColor
        
        if not na(h15) and math.abs(h15 - maxHigh) <= tolerancePrice
            labelText := str.length(labelText) > 0 ? labelText + ", 15m H" : "15m H"
            if str.length(labelText) == 5
                labelColor := color15minColor
        
        if not na(h30) and math.abs(h30 - maxHigh) <= tolerancePrice
            labelText := str.length(labelText) > 0 ? labelText + ", 30m H" : "30m H"
            if str.length(labelText) == 5
                labelColor := color30minColor
    
    [labelText, labelColor, labelPrice]

buildLowLabel() =>
    string labelText = ""
    color labelColor = color.white
    float labelPrice = na
    
    float l5 = show5minORB and not na(orb5Low) ? orb5Low : na
    float l15 = show15minORB and not na(orb15Low) ? orb15Low : na
    float l30 = show30minORB and not na(orb30Low) ? orb30Low : na
    
    float minLow = na
    if not na(l5)
        minLow := l5
    if not na(l15)
        minLow := na(minLow) ? l15 : math.min(minLow, l15)
    if not na(l30)
        minLow := na(minLow) ? l30 : math.min(minLow, l30)
    
    labelPrice := minLow
    
    if not na(minLow)
        if not na(l5) and math.abs(l5 - minLow) <= tolerancePrice
            labelText := "5m L"
            labelColor := color5minColor
        
        if not na(l15) and math.abs(l15 - minLow) <= tolerancePrice
            labelText := str.length(labelText) > 0 ? labelText + ", 15m L" : "15m L"
            if str.length(labelText) == 4
                labelColor := color15minColor
        
        if not na(l30) and math.abs(l30 - minLow) <= tolerancePrice
            labelText := str.length(labelText) > 0 ? labelText + ", 30m L" : "30m L"
            if str.length(labelText) == 5
                labelColor := color30minColor
    
    [labelText, labelColor, labelPrice]

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ORB FORMATION LOGIC
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

if isSessionStart
    sessionStartBar := bar_index
    
    // Reset 5min ORB
    orb5High := high
    orb5Low := low
    orb5Complete := false
    orb5StartBar := bar_index
    
    // Reset 15min ORB
    orb15High := high
    orb15Low := low
    orb15Complete := false
    orb15StartBar := bar_index
    
    // Reset 30min ORB
    orb30High := high
    orb30Low := low
    orb30Complete := false
    orb30StartBar := bar_index
    orb30Range := na
    orb30Mid := na
    
    // Reset breakout tracking
    broke30High := false
    broke30Low := false
    breakoutBar := na
    breakoutPrice := na
    
    // Delete previous session lines
    if not na(line5High)
        line.delete(line5High)
        line.delete(line5Low)
        line.delete(line15High)
        line.delete(line15Low)
        line.delete(line30High)
        line.delete(line30Low)
    
    if not na(labelHighCombined)
        label.delete(labelHighCombined)
        labelHighCombined := na
    if not na(labelLowCombined)
        label.delete(labelLowCombined)
        labelLowCombined := na
    
    line5High := na
    line5Low := na
    line15High := na
    line15Low := na
    line30High := na
    line30Low := na
    
    // Delete target lines and labels
    for tline in upTargetLines
        line.delete(tline)
    for tline in downTargetLines
        line.delete(tline)
    for tlabel in upTargetLabels
        label.delete(tlabel)
    for tlabel in downTargetLabels
        label.delete(tlabel)
    
    array.clear(upTargetLines)
    array.clear(downTargetLines)
    array.clear(upTargetLabels)
    array.clear(downTargetLabels)
    
    // Clear FVG boxes at session start
    for fvgBox in fvgBoxes
        box.delete(fvgBox)
    array.clear(fvgBoxes)
    array.clear(fvgHighs)
    array.clear(fvgLows)
    array.clear(fvgBullish)
    array.clear(fvgStartBars)
    
    // Clear iFVG boxes
    for ifvgBox in ifvgBoxes
        box.delete(ifvgBox)
    array.clear(ifvgBoxes)
    array.clear(ifvgHighs)
    array.clear(ifvgLows)
    array.clear(ifvgBullish)
    array.clear(ifvgStartBars)
    
    // Clear S/D zones at session start (optional - keep relevant zones)
    for sBox in supplyBoxes
        box.delete(sBox)
    array.clear(supplyBoxes)
    array.clear(supplyHighs)
    array.clear(supplyLows)
    array.clear(supplyStartBars)
    array.clear(supplyTouches)
    
    for dBox in demandBoxes
        box.delete(dBox)
    array.clear(demandBoxes)
    array.clear(demandHighs)
    array.clear(demandLows)
    array.clear(demandStartBars)
    array.clear(demandTouches)

// Timeframe-aware bar calculation
float tfMinutes = timeframe.in_seconds() / 60

// Update ORBs during formation
if isActiveSession
    // 5-minute ORB formation
    if not orb5Complete
        if high > orb5High
            orb5High := high
        if low < orb5Low
            orb5Low := low
        
        int bars5min = int(5 / tfMinutes)
        if bar_index >= orb5StartBar + bars5min
            orb5Complete := true
    
    // 15-minute ORB formation
    if not orb15Complete
        if high > orb15High
            orb15High := high
        if low < orb15Low
            orb15Low := low
        
        int bars15min = int(15 / tfMinutes)
        if bar_index >= orb15StartBar + bars15min
            orb15Complete := true
    
    // 30-minute ORB formation
    if not orb30Complete
        if high > orb30High
            orb30High := high
        if low < orb30Low
            orb30Low := low
        
        int bars30min = int(30 / tfMinutes)
        if bar_index >= orb30StartBar + bars30min
            orb30Complete := true
            orb30Range := orb30High - orb30Low
            orb30Mid := (orb30High + orb30Low) / 2

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// BREAKOUT DETECTION WITH CONFIRMATION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Valid breakout above 30min ORB High
bool validBreakoutUp = orb30Complete and 
                       isActiveSession and
                       not broke30High and
                       close > orb30High and
                       close[1] <= orb30High and
                       isHighVolume and
                       isBullishMomentum()

// Valid breakout below 30min ORB Low
bool validBreakoutDown = orb30Complete and 
                         isActiveSession and
                         not broke30Low and
                         close < orb30Low and
                         close[1] >= orb30Low and
                         isHighVolume and
                         isBearishMomentum()

// Track breakouts
if validBreakoutUp
    broke30High := true
    breakoutBar := bar_index
    breakoutPrice := close

if validBreakoutDown
    broke30Low := true
    breakoutBar := bar_index
    breakoutPrice := close

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ZONE TOUCH DETECTION FOR ENTRIES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

isTouchingBullishFVG() =>
    bool touching = false
    if array.size(fvgBoxes) > 0
        for i = 0 to array.size(fvgBoxes) - 1
            if i < array.size(fvgBoxes) and array.get(fvgBullish, i) == true
                float fvgH = array.get(fvgHighs, i)
                float fvgL = array.get(fvgLows, i)
                if low <= fvgH and high >= fvgL
                    touching := true
                    break
    touching

isTouchingBearishFVG() =>
    bool touching = false
    if array.size(fvgBoxes) > 0
        for i = 0 to array.size(fvgBoxes) - 1
            if i < array.size(fvgBoxes) and array.get(fvgBullish, i) == false
                float fvgH = array.get(fvgHighs, i)
                float fvgL = array.get(fvgLows, i)
                if low <= fvgH and high >= fvgL
                    touching := true
                    break
    touching

isTouchingDemandZone() =>
    bool touching = false
    if array.size(demandBoxes) > 0
        for i = 0 to array.size(demandBoxes) - 1
            if i < array.size(demandBoxes)
                float zH = array.get(demandHighs, i)
                float zL = array.get(demandLows, i)
                if low <= zH and low >= zL
                    touching := true
                    break
    touching

isTouchingSupplyZone() =>
    bool touching = false
    if array.size(supplyBoxes) > 0
        for i = 0 to array.size(supplyBoxes) - 1
            if i < array.size(supplyBoxes)
                float zH = array.get(supplyHighs, i)
                float zL = array.get(supplyLows, i)
                if high >= zL and high <= zH
                    touching := true
                    break
    touching

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// RETEST ENTRY SIGNALS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Retest of 30min High after breakout (bullish continuation)
bool retestHighBullish = broke30High and 
                         bar_index > breakoutBar + 1 and
                         low <= orb30High and 
                         low >= orb30High - (orb30Range * 0.15) and
                         close > orb30High and
                         (isBullishEngulfing() or (isBullishMomentum() and isTouchingBullishFVG()))

// Retest of 30min Low after breakout (bearish continuation)
bool retestLowBearish = broke30Low and bar_index > breakoutBar + 1 and high >= orb30Low and high <= orb30Low + (orb30Range * 0.15) and close < orb30Low and (isBearishEngulfing() or (isBearishMomentum() and isTouchingBearishFVG()))

// FVG + Engulfing combo entries
bool fvgBullishEntry = isTouchingBullishFVG() and isBullishEngulfing() and close > orb30Low
bool fvgBearishEntry = isTouchingBearishFVG() and isBearishEngulfing() and close < orb30High

// S/D Zone entries
bool demandZoneEntry = isTouchingDemandZone() and isBullishEngulfing()
bool supplyZoneEntry = isTouchingSupplyZone() and isBearishEngulfing()

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// FAKEOUT & ABSORPTION DETECTION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

bool fakeoutUpWarning = broke30High and  bar_index > breakoutBar and close < orb30Mid and isBearishMomentum()

bool fakeoutDownWarning = broke30Low and 
                          bar_index > breakoutBar and
                          close > orb30Mid and
                          isBullishMomentum()

bool absorptionAtHigh = orb30Complete and high >= orb30High - (orb30Range * 0.05) and isShootingStar() and isHighVolume

bool absorptionAtLow = orb30Complete and 
                       low <= orb30Low + (orb30Range * 0.05) and
                       isHammer() and
                       isHighVolume

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// DRAW ORB LINES
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

if isActiveSession and not na(orb5High)
    // 5-MIN ORB LINES
    if show5minORB
        if na(line5High)
            line5High := line.new(orb5StartBar, orb5High, bar_index, orb5High, color=color5minColor, width=line5minWidth)
            line5Low := line.new(orb5StartBar, orb5Low, bar_index, orb5Low, color=color5minColor, width=line5minWidth)
        else
            line.set_y1(line5High, orb5High)
            line.set_y2(line5High, orb5High)
            line.set_x2(line5High, bar_index)
            line.set_y1(line5Low, orb5Low)
            line.set_y2(line5Low, orb5Low)
            line.set_x2(line5Low, bar_index)
    else
        if not na(line5High)
            line.delete(line5High)
            line.delete(line5Low)
            line5High := na
            line5Low := na
    
    // 15-MIN ORB LINES
    if show15minORB
        if na(line15High)
            line15High := line.new(orb15StartBar, orb15High, bar_index, orb15High, color=color15minColor, width=line15minWidth)
            line15Low := line.new(orb15StartBar, orb15Low, bar_index, orb15Low, color=color15minColor, width=line15minWidth)
        else
            line.set_y1(line15High, orb15High)
            line.set_y2(line15High, orb15High)
            line.set_x2(line15High, bar_index)
            line.set_y1(line15Low, orb15Low)
            line.set_y2(line15Low, orb15Low)
            line.set_x2(line15Low, bar_index)
    else
        if not na(line15High)
            line.delete(line15High)
            line.delete(line15Low)
            line15High := na
            line15Low := na
    
    // 30-MIN ORB LINES
    if show30minORB
        if na(line30High)
            line30High := line.new(orb30StartBar, orb30High, bar_index, orb30High, color=color30minColor, width=line30minWidth)
            line30Low := line.new(orb30StartBar, orb30Low, bar_index, orb30Low, color=color30minColor, width=line30minWidth)
        else
            line.set_y1(line30High, orb30High)
            line.set_y2(line30High, orb30High)
            line.set_x2(line30High, bar_index)
            line.set_y1(line30Low, orb30Low)
            line.set_y2(line30Low, orb30Low)
            line.set_x2(line30Low, bar_index)
    else
        if not na(line30High)
            line.delete(line30High)
            line.delete(line30Low)
            line30High := na
            line30Low := na
    
    // SMART COMBINED LABELS
    if not na(labelHighCombined)
        label.delete(labelHighCombined)
        labelHighCombined := na
    if not na(labelLowCombined)
        label.delete(labelLowCombined)
        labelLowCombined := na
    
    [highText, highColor, highPrice] = buildHighLabel()
    if str.length(highText) > 0 and not na(highPrice)
        labelHighCombined := label.new(bar_index, highPrice, highText, 
                                       style=label.style_label_left, 
                                       color=color.new(color.black, 100), 
                                       textcolor=highColor, 
                                       size=txtSizeFormat)
    
    [lowText, lowColor, lowPrice] = buildLowLabel()
    if str.length(lowText) > 0 and not na(lowPrice)
        labelLowCombined := label.new(bar_index, lowPrice, lowText, 
                                      style=label.style_label_left, 
                                      color=color.new(color.black, 100), 
                                      textcolor=lowColor, 
                                      size=txtSizeFormat)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// TARGET GENERATION
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

if orb30Complete and array.size(upTargetLines) == 0
    float orbRange = orb30High - orb30Low
    
    for i = 1 to numTargets
        float targetPrice = orb30High + (orbRange * targetPct * i)
        line tline = line.new(bar_index, targetPrice, bar_index, targetPrice, 
                              color=colorTargetUp, width=targetLineWidth, style=line.style_dashed)
        label tlabel = label.new(bar_index, targetPrice, str.tostring(i) + "x", 
                                 style=label.style_label_left, color=color.new(color.black, 100), 
                                 textcolor=colorTargetUp, size=txtSizeFormat)
        array.push(upTargetLines, tline)
        array.push(upTargetLabels, tlabel)
    
    for i = 1 to numTargets
        float targetPrice = orb30Low - (orbRange * targetPct * i)
        line tline = line.new(bar_index, targetPrice, bar_index, targetPrice, 
                              color=colorTargetDown, width=targetLineWidth, style=line.style_dashed)
        label tlabel = label.new(bar_index, targetPrice, str.tostring(i) + "x", 
                                 style=label.style_label_left, color=color.new(color.black, 100), 
                                 textcolor=colorTargetDown, size=txtSizeFormat)
        array.push(downTargetLines, tline)
        array.push(downTargetLabels, tlabel)

if isActiveSession and orb30Complete
    for tline in upTargetLines
        line.set_x2(tline, bar_index)
    for tlabel in upTargetLabels
        label.set_x(tlabel, bar_index)
    
    for tline in downTargetLines
        line.set_x2(tline, bar_index)
    for tlabel in downTargetLabels
        label.set_x(tlabel, bar_index)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// SESSION END CLEANUP
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

if isSessionEnd
    if not na(line5High)
        line.delete(line5High)
        line.delete(line5Low)
        line5High := na
        line5Low := na
    
    if not na(line15High)
        line.delete(line15High)
        line.delete(line15Low)
        line15High := na
        line15Low := na
    
    if not na(line30High)
        line.delete(line30High)
        line.delete(line30Low)
        line30High := na
        line30Low := na
    
    if not na(labelHighCombined)
        label.delete(labelHighCombined)
        labelHighCombined := na
    if not na(labelLowCombined)
        label.delete(labelLowCombined)
        labelLowCombined := na
    
    for tline in upTargetLines
        line.delete(tline)
    for tline in downTargetLines
        line.delete(tline)
    for tlabel in upTargetLabels
        label.delete(tlabel)
    for tlabel in downTargetLabels
        label.delete(tlabel)
    
    array.clear(upTargetLines)
    array.clear(downTargetLines)
    array.clear(upTargetLabels)
    array.clear(downTargetLabels)
    
    // Clean up FVG boxes
    for fvgBox in fvgBoxes
        box.delete(fvgBox)
    array.clear(fvgBoxes)
    array.clear(fvgHighs)
    array.clear(fvgLows)
    array.clear(fvgBullish)
    array.clear(fvgStartBars)
    
    // Clean up iFVG boxes
    for ifvgBox in ifvgBoxes
        box.delete(ifvgBox)
    array.clear(ifvgBoxes)
    array.clear(ifvgHighs)
    array.clear(ifvgLows)
    array.clear(ifvgBullish)
    array.clear(ifvgStartBars)
    
    // Clean up S/D zones
    for sBox in supplyBoxes
        box.delete(sBox)
    array.clear(supplyBoxes)
    array.clear(supplyHighs)
    array.clear(supplyLows)
    array.clear(supplyStartBars)
    array.clear(supplyTouches)
    
    for dBox in demandBoxes
        box.delete(dBox)
    array.clear(demandBoxes)
    array.clear(demandHighs)
    array.clear(demandLows)
    array.clear(demandStartBars)
    array.clear(demandTouches)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// PLOT SIGNALS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// Confirmed breakout signals
plotshape(showConfirmationSignals and validBreakoutUp, "Breakout Up", shape.triangleup, location.belowbar, 
          colorBullishConfirm, size=size.normal, text="ORB↑", textcolor=colorBullishConfirm)
plotshape(showConfirmationSignals and validBreakoutDown, "Breakout Down", shape.triangledown, location.abovebar, 
          colorBearishConfirm, size=size.normal, text="ORB↓", textcolor=colorBearishConfirm)

// Retest entry signals
plotshape(showRetestSignals and retestHighBullish, "Retest Long", shape.labelup, location.belowbar, 
          color.new(colorBullishConfirm, 0), size=size.small, text="RT↑", textcolor=color.white)
plotshape(showRetestSignals and retestLowBearish, "Retest Short", shape.labeldown, location.abovebar, 
          color.new(colorBearishConfirm, 0), size=size.small, text="RT↓", textcolor=color.white)

// FVG + Engulfing combo
plotshape(showRetestSignals and fvgBullishEntry and not retestHighBullish, "FVG Long", shape.diamond, location.belowbar, 
          color.new(#00BCD4, 0), size=size.tiny, text="FVG↑", textcolor=color.new(#00BCD4, 0))
plotshape(showRetestSignals and fvgBearishEntry and not retestLowBearish, "FVG Short", shape.diamond, location.abovebar, 
          color.new(#00BCD4, 0), size=size.tiny, text="FVG↓", textcolor=color.new(#00BCD4, 0))

// S/D Zone entries
plotshape(showRetestSignals and demandZoneEntry and not fvgBullishEntry, "Demand Entry", shape.circle, location.belowbar, 
          colorDemandZone, size=size.tiny, text="D↑", textcolor=colorDemandZone)
plotshape(showRetestSignals and supplyZoneEntry and not fvgBearishEntry, "Supply Entry", shape.circle, location.abovebar, 
          colorSupplyZone, size=size.tiny, text="S↓", textcolor=colorSupplyZone)

// Absorption warnings
plotshape(absorptionAtHigh, "Absorption High", shape.xcross, location.abovebar, 
          color.new(#FF9800, 0), size=size.tiny, text="ABS", textcolor=color.new(#FF9800, 0))
plotshape(absorptionAtLow, "Absorption Low", shape.xcross, location.belowbar, 
          color.new(#FF9800, 0), size=size.tiny, text="ABS", textcolor=color.new(#FF9800, 0))

// Fakeout warnings
plotshape(fakeoutUpWarning, "Fakeout Up", shape.cross, location.abovebar, 
          color.new(#F44336, 0), size=size.tiny, text="FK!", textcolor=color.new(#F44336, 0))
plotshape(fakeoutDownWarning, "Fakeout Down", shape.cross, location.belowbar, 
          color.new(#F44336, 0), size=size.tiny, text="FK!", textcolor=color.new(#F44336, 0))

// Highlight confirmation candles
barcolor(highlightConfirmCandles and validBreakoutUp ? colorBullishConfirm : na)
barcolor(highlightConfirmCandles and validBreakoutDown ? colorBearishConfirm : na)
barcolor(highlightConfirmCandles and retestHighBullish ? color.new(#00E676, 30) : na)
barcolor(highlightConfirmCandles and retestLowBearish ? color.new(#FF5252, 30) : na)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// PLOT VWAP
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

plot(showVWAP and isActiveSession ? vwap : na, "Anchored VWAP", color=vwapColor, linewidth=vwapWidth, style=plot.style_linebr)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// INFO TABLE
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

var table infoTable = table.new(position.top_right, 2, 15, border_width=1)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "SNIPER ORB V4.3", text_color=color.white, bgcolor=color.new(#673AB7, 20), text_size=size.small)
    string activeKZ = inAsian ? "ASIA" : inLondonKZ ? "LDN" : inNYKZ ? "NY" : "—"
    table.cell(infoTable, 1, 0, activeKZ, text_color=color.white, bgcolor=color.new(#673AB7, 20), text_size=size.small)
    
    // Killzone Ranges
    string asiaRange = not na(asianHigh) and not na(asianLow) ? str.tostring(asianHigh - asianLow, format.mintick) : "—"
    table.cell(infoTable, 0, 1, "Asia Range", text_color=colorAsianHigh, text_size=size.tiny)
    table.cell(infoTable, 1, 1, asiaRange, text_color=color.white, text_size=size.tiny)
    
    string ldnRange = not na(londonKZHigh) and not na(londonKZLow) ? str.tostring(londonKZHigh - londonKZLow, format.mintick) : "—"
    table.cell(infoTable, 0, 2, "LDN Range", text_color=colorLondonHigh, text_size=size.tiny)
    table.cell(infoTable, 1, 2, ldnRange, text_color=color.white, text_size=size.tiny)
    
    string nyRange = not na(nyKZHigh) and not na(nyKZLow) ? str.tostring(nyKZHigh - nyKZLow, format.mintick) : "—"
    table.cell(infoTable, 0, 3, "NY Range", text_color=colorNYHigh, text_size=size.tiny)
    table.cell(infoTable, 1, 3, nyRange, text_color=color.white, text_size=size.tiny)
    
    // ORB info (only if session active and ORB complete)
    if isActiveSession and orb30Complete
        table.cell(infoTable, 0, 4, "30m ORB", text_color=color30minColor, text_size=size.tiny)
        table.cell(infoTable, 1, 4, str.tostring(orb30Range, format.mintick), text_color=color.white, text_size=size.tiny)
        
        table.cell(infoTable, 0, 5, "VWAP", text_color=vwapColor, text_size=size.tiny)
        table.cell(infoTable, 1, 5, str.tostring(vwap, format.mintick), text_color=color.white, text_size=size.tiny)
        
        // Breakout status
        string bkStatus = broke30High ? "🔼 BROKE HIGH" : broke30Low ? "🔽 BROKE LOW" : "📊 IN RANGE"
        color bkColor = broke30High ? colorBullishConfirm : broke30Low ? colorBearishConfirm : color.yellow
        table.cell(infoTable, 0, 6, "Status", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 6, bkStatus, text_color=bkColor, text_size=size.tiny)
    else
        table.cell(infoTable, 0, 4, "30m ORB", text_color=color30minColor, text_size=size.tiny)
        table.cell(infoTable, 1, 4, "—", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 0, 5, "VWAP", text_color=vwapColor, text_size=size.tiny)
        table.cell(infoTable, 1, 5, "—", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 0, 6, "Status", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 6, "—", text_color=color.gray, text_size=size.tiny)
    
    // ATR for volatility context
    table.cell(infoTable, 0, 7, "ATR(14)", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 7, str.tostring(atrValue, format.mintick), text_color=isHighVolatility ? color.orange : color.white, text_size=size.tiny)
    
    // Volume status
    string volStatus = isHighVolume ? "✓ HIGH VOL" : "○ Normal"
    table.cell(infoTable, 0, 8, "Volume", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 8, volStatus, text_color=isHighVolume ? color.green : color.gray, text_size=size.tiny)
    
    // Body strength
    string bodyStatus = bodyPercent >= 70 ? "💪 STRONG" : bodyPercent >= 50 ? "○ Normal" : "⚠️ Weak"
    table.cell(infoTable, 0, 9, "Body", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 9, bodyStatus, text_color=bodyPercent >= 70 ? color.green : bodyPercent >= 50 ? color.gray : color.orange, text_size=size.tiny)
    
    // Zone counts
    table.cell(infoTable, 0, 10, "FVGs", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 10, str.tostring(array.size(fvgBoxes)) + " / " + str.tostring(array.size(ifvgBoxes)) + " iFVG", text_color=color.white, text_size=size.tiny)
    
    table.cell(infoTable, 0, 11, "Supply", text_color=colorSupplyZone, text_size=size.tiny)
    table.cell(infoTable, 1, 11, str.tostring(array.size(supplyBoxes)), text_color=color.white, text_size=size.tiny)
    
    table.cell(infoTable, 0, 12, "Demand", text_color=colorDemandZone, text_size=size.tiny)
    table.cell(infoTable, 1, 12, str.tostring(array.size(demandBoxes)), text_color=color.white, text_size=size.tiny)

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// ALERTS
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════

// ORB Alerts
alertcondition(validBreakoutUp, "ORB Breakout Up", "SNIPER ORB V4.3: Confirmed breakout above 30m ORB High")
alertcondition(validBreakoutDown, "ORB Breakout Down", "SNIPER ORB V4.3: Confirmed breakout below 30m ORB Low")
alertcondition(retestHighBullish, "Retest Long Entry", "SNIPER ORB V4.3: Bullish retest entry at ORB High")
alertcondition(retestLowBearish, "Retest Short Entry", "SNIPER ORB V4.3: Bearish retest entry at ORB Low")

// Zone Entry Alerts
alertcondition(fvgBullishEntry, "FVG Long Entry", "SNIPER ORB V4.3: FVG + Engulfing bullish entry")
alertcondition(fvgBearishEntry, "FVG Short Entry", "SNIPER ORB V4.3: FVG + Engulfing bearish entry")
alertcondition(demandZoneEntry, "Demand Zone Entry", "SNIPER ORB V4.3: Bullish entry at Demand Zone")
alertcondition(supplyZoneEntry, "Supply Zone Entry", "SNIPER ORB V4.3: Bearish entry at Supply Zone")

// Warning Alerts
alertcondition(absorptionAtHigh or absorptionAtLow, "Absorption Detected", "SNIPER ORB V4.3: Institutional absorption at ORB level")
alertcondition(fakeoutUpWarning or fakeoutDownWarning, "Fakeout Warning", "SNIPER ORB V4.3: Potential fakeout detected")

// Session Alerts
alertcondition(orb30Complete and not orb30Complete[1], "ORB Complete", "SNIPER ORB V4.3: 30-minute ORB formation complete")
alertcondition(isHighVolatility, "High Volatility", "SNIPER ORB V4.3: Volatility expansion detected")

// Killzone Session Alerts
alertcondition(asianStart, "Asian Session Start", "SNIPER ORB V4.3: Asian session started (6:00 PM EST)")
alertcondition(asianEnd, "Asian Session End", "SNIPER ORB V4.3: Asian session ended (2:59 AM EST)")
alertcondition(londonKZStart, "London Session Start", "SNIPER ORB V4.3: London session started (3:00 AM EST)")
alertcondition(londonKZEnd, "London Session End", "SNIPER ORB V4.3: London session ended (9:29 AM EST)")
alertcondition(nyKZStart, "New York Session Start", "SNIPER ORB V4.3: New York session started (9:30 AM EST)")
alertcondition(nyKZEnd, "New York Session End", "SNIPER ORB V4.3: New York session ended (5:00 PM EST)")
alertcondition(isDailyReset, "Daily Reset", "SNIPER ORB V4.3: Daily reset at 6:00 PM EST (Globex open)")

//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
// END OF SNIPER ORB V4.3 - ENHANCED ZONE MANAGEMENT
//═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
