//@version=6
indicator("SNIPER ORB", shorttitle="SNIPER ORB", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

//═══════════════════════════════════════════════════════════════════════════════════════
// INPUTS
//═══════════════════════════════════════════════════════════════════════════════════════

// Session Selection
sessionType = input.string("New York", "Active Session", options=["London", "New York"], group="Session Settings")

// Target Configuration
numTargets = input.int(3, "Number of Targets", minval=1, maxval=10, group="Target Settings")
targetPct = input.float(50.0, "Target % of 30min Range", minval=10, maxval=200, group="Target Settings") * 0.01

// ORB Line Colors (UNIQUE FOR EACH PERIOD)
color5minColor = input.color(color.new(#2196F3, 0), "5min ORB", inline="orb5", group="ORB Colors")
line5minWidth = input.int(3, "", minval=1, maxval=5, inline="orb5", group="ORB Colors")

color15minColor = input.color(color.new(#00BCD4, 0), "15min ORB", inline="orb15", group="ORB Colors")
line15minWidth = input.int(2, "", minval=1, maxval=5, inline="orb15", group="ORB Colors")

color30minColor = input.color(color.new(#9C27B0, 0), "30min ORB", inline="orb30", group="ORB Colors")
line30minWidth = input.int(2, "", minval=1, maxval=5, inline="orb30", group="ORB Colors")

// Target Line Colors (UNIQUE)
colorTargetUp = input.color(color.new(#4CAF50, 0), "Upside Targets", inline="tgt", group="Target Colors")
colorTargetDown = input.color(color.new(#F44336, 0), "Downside Targets", inline="tgt", group="Target Colors")
targetLineWidth = input.int(1, "Width", minval=1, maxval=3, inline="tgt", group="Target Colors")

// VWAP Settings
showVWAP = input.bool(true, "Show Anchored VWAP", group="VWAP Settings")
vwapColor = input.color(color.new(#FFC107, 0), "VWAP Color", group="VWAP Settings")
vwapWidth = input.int(2, "VWAP Width", minval=1, maxval=5, group="VWAP Settings")

// Text Size
txtSize = input.string("Small", "Label Size", options=["Tiny","Small","Normal","Large"], group="Display Settings")
txtSizeFormat = txtSize == "Tiny" ? size.tiny : txtSize == "Small" ? size.small : txtSize == "Normal" ? size.normal : size.large

//═══════════════════════════════════════════════════════════════════════════════════════
// SESSION DETECTION
//═══════════════════════════════════════════════════════════════════════════════════════

string tz = "America/New_York"

// London: 3:00 AM - 9:30 AM ET
string londonSpec = "0300-0930:23456"
bool inLondon = not na(time(timeframe.period, londonSpec, tz))
bool londonStart = inLondon and not inLondon[1]
bool londonEnd = inLondon[1] and not inLondon

// New York: 9:30 AM - 5:00 PM ET (1700 = 5:00 PM)
string nySpec = "0930-1700:23456"
bool inNY = not na(time(timeframe.period, nySpec, tz))
bool nyStart = inNY and not inNY[1]
bool nyEnd = inNY[1] and not inNY

// Active session based on user selection
bool isActiveSession = sessionType == "London" ? inLondon : inNY
bool isSessionStart = sessionType == "London" ? londonStart : nyStart
bool isSessionEnd = sessionType == "London" ? londonEnd : nyEnd

//═══════════════════════════════════════════════════════════════════════════════════════
// ORB STATE VARIABLES
//═══════════════════════════════════════════════════════════════════════════════════════

// 5-minute ORB
var float orb5High = na
var float orb5Low = na
var bool orb5Complete = false
var int orb5StartBar = na

// 15-minute ORB
var float orb15High = na
var float orb15Low = na
var bool orb15Complete = false
var int orb15StartBar = na

// 30-minute ORB
var float orb30High = na
var float orb30Low = na
var bool orb30Complete = false
var int orb30StartBar = na

// Session tracking
var int sessionStartBar = na

// Line objects for ORBs
var line line5High = na
var line line5Low = na
var line line15High = na
var line line15Low = na
var line line30High = na
var line line30Low = na

// Label objects
var label label5High = na
var label label5Low = na
var label label15High = na
var label label15Low = na
var label label30High = na
var label label30Low = na

// Target arrays
var array<line> upTargetLines = array.new<line>()
var array<line> downTargetLines = array.new<line>()
var array<label> upTargetLabels = array.new<label>()
var array<label> downTargetLabels = array.new<label>()

//═══════════════════════════════════════════════════════════════════════════════════════
// ANCHORED VWAP CALCULATION
//═══════════════════════════════════════════════════════════════════════════════════════

var float cumPV = 0.0
var float cumV = 0.0

if isSessionStart
    cumPV := 0.0
    cumV := 0.0

if isActiveSession
    float tp = hlc3
    cumPV += tp * volume
    cumV += volume

float vwap = cumV > 0 ? cumPV / cumV : na

//═══════════════════════════════════════════════════════════════════════════════════════
// ORB FORMATION LOGIC
//═══════════════════════════════════════════════════════════════════════════════════════

// Calculate minutes elapsed since session start
int minutesElapsed = isActiveSession ? int((time - time[1]) / 60000) : 0
int totalMinutes = isActiveSession and sessionStartBar >= 0 ? int((bar_index - sessionStartBar)) : 0

// Session start - initialize all ORBs
if isSessionStart
    sessionStartBar := bar_index
    
    // Reset 5min ORB
    orb5High := high
    orb5Low := low
    orb5Complete := false
    orb5StartBar := bar_index
    
    // Reset 15min ORB
    orb15High := high
    orb15Low := low
    orb15Complete := false
    orb15StartBar := bar_index
    
    // Reset 30min ORB
    orb30High := high
    orb30Low := low
    orb30Complete := false
    orb30StartBar := bar_index
    
    // Delete previous session lines and labels
    if not na(line5High)
        line.delete(line5High)
        line.delete(line5Low)
        line.delete(line15High)
        line.delete(line15Low)
        line.delete(line30High)
        line.delete(line30Low)
    
    if not na(label5High)
        label.delete(label5High)
        label.delete(label5Low)
        label.delete(label15High)
        label.delete(label15Low)
        label.delete(label30High)
        label.delete(label30Low)
    
    // Delete target lines and labels
    for tline in upTargetLines
        line.delete(tline)
    for tline in downTargetLines
        line.delete(tline)
    for tlabel in upTargetLabels
        label.delete(tlabel)
    for tlabel in downTargetLabels
        label.delete(tlabel)
    
    array.clear(upTargetLines)
    array.clear(downTargetLines)
    array.clear(upTargetLabels)
    array.clear(downTargetLabels)

// Determine timeframe period in minutes
float tfMinutes = timeframe.in_seconds() / 60

// Update ORBs during formation
if isActiveSession
    // 5-minute ORB formation
    if not orb5Complete
        if high > orb5High
            orb5High := high
        if low < orb5Low
            orb5Low := low
        
        // Check if 5 minutes have passed (depends on chart timeframe)
        int bars5min = int(5 / tfMinutes)
        if bar_index >= orb5StartBar + bars5min
            orb5Complete := true
    
    // 15-minute ORB formation
    if not orb15Complete
        if high > orb15High
            orb15High := high
        if low < orb15Low
            orb15Low := low
        
        int bars15min = int(15 / tfMinutes)
        if bar_index >= orb15StartBar + bars15min
            orb15Complete := true
    
    // 30-minute ORB formation
    if not orb30Complete
        if high > orb30High
            orb30High := high
        if low < orb30Low
            orb30Low := low
        
        int bars30min = int(30 / tfMinutes)
        if bar_index >= orb30StartBar + bars30min
            orb30Complete := true

//═══════════════════════════════════════════════════════════════════════════════════════
// DRAW ORB LINES (ACTIVE SESSION ONLY)
//═══════════════════════════════════════════════════════════════════════════════════════

if isActiveSession and not na(orb5High)
    // 5-min ORB lines
    if na(line5High)
        line5High := line.new(orb5StartBar, orb5High, bar_index, orb5High, color=color5minColor, width=line5minWidth)
        line5Low := line.new(orb5StartBar, orb5Low, bar_index, orb5Low, color=color5minColor, width=line5minWidth)
        
        label5High := label.new(bar_index, orb5High, "5m H", style=label.style_label_left, 
                                color=color.new(color.black, 100), textcolor=color5minColor, size=txtSizeFormat)
        label5Low := label.new(bar_index, orb5Low, "5m L", style=label.style_label_left, 
                               color=color.new(color.black, 100), textcolor=color5minColor, size=txtSizeFormat)
    else
        line.set_y1(line5High, orb5High)
        line.set_y2(line5High, orb5High)
        line.set_x2(line5High, bar_index)
        
        line.set_y1(line5Low, orb5Low)
        line.set_y2(line5Low, orb5Low)
        line.set_x2(line5Low, bar_index)
        
        label.set_xy(label5High, bar_index, orb5High)
        label.set_xy(label5Low, bar_index, orb5Low)
    
    // 15-min ORB lines
    if na(line15High)
        line15High := line.new(orb15StartBar, orb15High, bar_index, orb15High, color=color15minColor, width=line15minWidth)
        line15Low := line.new(orb15StartBar, orb15Low, bar_index, orb15Low, color=color15minColor, width=line15minWidth)
        
        label15High := label.new(bar_index, orb15High, "15m H", style=label.style_label_left, 
                                 color=color.new(color.black, 100), textcolor=color15minColor, size=txtSizeFormat)
        label15Low := label.new(bar_index, orb15Low, "15m L", style=label.style_label_left, 
                                color=color.new(color.black, 100), textcolor=color15minColor, size=txtSizeFormat)
    else
        line.set_y1(line15High, orb15High)
        line.set_y2(line15High, orb15High)
        line.set_x2(line15High, bar_index)
        
        line.set_y1(line15Low, orb15Low)
        line.set_y2(line15Low, orb15Low)
        line.set_x2(line15Low, bar_index)
        
        label.set_xy(label15High, bar_index, orb15High)
        label.set_xy(label15Low, bar_index, orb15Low)
    
    // 30-min ORB lines
    if na(line30High)
        line30High := line.new(orb30StartBar, orb30High, bar_index, orb30High, color=color30minColor, width=line30minWidth)
        line30Low := line.new(orb30StartBar, orb30Low, bar_index, orb30Low, color=color30minColor, width=line30minWidth)
        
        label30High := label.new(bar_index, orb30High, "30m H", style=label.style_label_left, 
                                 color=color.new(color.black, 100), textcolor=color30minColor, size=txtSizeFormat)
        label30Low := label.new(bar_index, orb30Low, "30m L", style=label.style_label_left, 
                                color=color.new(color.black, 100), textcolor=color30minColor, size=txtSizeFormat)
    else
        line.set_y1(line30High, orb30High)
        line.set_y2(line30High, orb30High)
        line.set_x2(line30High, bar_index)
        
        line.set_y1(line30Low, orb30Low)
        line.set_y2(line30Low, orb30Low)
        line.set_x2(line30Low, bar_index)
        
        label.set_xy(label30High, bar_index, orb30High)
        label.set_xy(label30Low, bar_index, orb30Low)

//═══════════════════════════════════════════════════════════════════════════════════════
// TARGET GENERATION (FROM 30MIN ORB ONLY)
//═══════════════════════════════════════════════════════════════════════════════════════

if orb30Complete and array.size(upTargetLines) == 0
    float orb30Range = orb30High - orb30Low
    
    // Generate upside targets
    for i = 1 to numTargets
        float targetPrice = orb30High + (orb30Range * targetPct * i)
        line tline = line.new(bar_index, targetPrice, bar_index, targetPrice, 
                              color=colorTargetUp, width=targetLineWidth, style=line.style_dashed)
        label tlabel = label.new(bar_index, targetPrice, str.tostring(i) + "x", 
                                 style=label.style_label_left, color=color.new(color.black, 100), 
                                 textcolor=colorTargetUp, size=txtSizeFormat)
        array.push(upTargetLines, tline)
        array.push(upTargetLabels, tlabel)
    
    // Generate downside targets
    for i = 1 to numTargets
        float targetPrice = orb30Low - (orb30Range * targetPct * i)
        line tline = line.new(bar_index, targetPrice, bar_index, targetPrice, 
                              color=colorTargetDown, width=targetLineWidth, style=line.style_dashed)
        label tlabel = label.new(bar_index, targetPrice, str.tostring(i) + "x", 
                                 style=label.style_label_left, color=color.new(color.black, 100), 
                                 textcolor=colorTargetDown, size=txtSizeFormat)
        array.push(downTargetLines, tline)
        array.push(downTargetLabels, tlabel)

// Extend target lines during active session
if isActiveSession and orb30Complete
    for tline in upTargetLines
        line.set_x2(tline, bar_index)
    for tlabel in upTargetLabels
        label.set_x(tlabel, bar_index)
    
    for tline in downTargetLines
        line.set_x2(tline, bar_index)
    for tlabel in downTargetLabels
        label.set_x(tlabel, bar_index)

//═══════════════════════════════════════════════════════════════════════════════════════
// SESSION END - DELETE ALL OBJECTS
//═══════════════════════════════════════════════════════════════════════════════════════

if isSessionEnd
    // Delete ORB lines
    if not na(line5High)
        line.delete(line5High)
        line.delete(line5Low)
        line5High := na
        line5Low := na
    
    if not na(line15High)
        line.delete(line15High)
        line.delete(line15Low)
        line15High := na
        line15Low := na
    
    if not na(line30High)
        line.delete(line30High)
        line.delete(line30Low)
        line30High := na
        line30Low := na
    
    // Delete labels
    if not na(label5High)
        label.delete(label5High)
        label.delete(label5Low)
        label5High := na
        label5Low := na
    
    if not na(label15High)
        label.delete(label15High)
        label.delete(label15Low)
        label15High := na
        label15Low := na
    
    if not na(label30High)
        label.delete(label30High)
        label.delete(label30Low)
        label30High := na
        label30Low := na
    
    // Delete target lines
    for tline in upTargetLines
        line.delete(tline)
    for tline in downTargetLines
        line.delete(tline)
    
    // Delete target labels
    for tlabel in upTargetLabels
        label.delete(tlabel)
    for tlabel in downTargetLabels
        label.delete(tlabel)
    
    // Clear arrays
    array.clear(upTargetLines)
    array.clear(downTargetLines)
    array.clear(upTargetLabels)
    array.clear(downTargetLabels)

//═══════════════════════════════════════════════════════════════════════════════════════
// PLOT ANCHORED VWAP (ONLY DURING ACTIVE SESSION)
//═══════════════════════════════════════════════════════════════════════════════════════

plot(showVWAP and isActiveSession ? vwap : na, "Anchored VWAP", color=vwapColor, linewidth=vwapWidth, style=plot.style_linebr)

//═══════════════════════════════════════════════════════════════════════════════════════
// INFO TABLE (OPTIONAL)
//═══════════════════════════════════════════════════════════════════════════════════════

var table infoTable = table.new(position.top_right, 2, 7, border_width=1)

if isActiveSession and orb30Complete
    table.cell(infoTable, 0, 0, "SNIPER ORB", text_color=color.white, bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 0, sessionType, text_color=color.white, bgcolor=color.new(color.gray, 30))
    
    table.cell(infoTable, 0, 1, "5m Range", text_color=color5minColor)
    table.cell(infoTable, 1, 1, str.tostring(orb5High - orb5Low, format.mintick), text_color=color.white)
    
    table.cell(infoTable, 0, 2, "15m Range", text_color=color15minColor)
    table.cell(infoTable, 1, 2, str.tostring(orb15High - orb15Low, format.mintick), text_color=color.white)
    
    table.cell(infoTable, 0, 3, "30m Range", text_color=color30minColor)
    table.cell(infoTable, 1, 3, str.tostring(orb30High - orb30Low, format.mintick), text_color=color.white)
    
    table.cell(infoTable, 0, 4, "VWAP", text_color=vwapColor)
    table.cell(infoTable, 1, 4, str.tostring(vwap, format.mintick), text_color=color.white)
    
    table.cell(infoTable, 0, 5, "Target Mult", text_color=color.gray)
    table.cell(infoTable, 1, 5, str.tostring(targetPct * 100) + "%", text_color=color.white)
    
    table.cell(infoTable, 0, 6, "Status", text_color=color.gray)
    string status = orb30Complete ? "✓ Complete" : "⏳ Forming"
    table.cell(infoTable, 1, 6, status, text_color=orb30Complete ? color.green : color.yellow)
else
    table.clear(infoTable, 0, 0, 1, 6)

//═══════════════════════════════════════════════════════════════════════════════════════
// END OF SNIPER ORB
//═══════════════════════════════════════════════════════════════════════════════════════
