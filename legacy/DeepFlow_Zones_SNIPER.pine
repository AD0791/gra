// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© Alexandro Disla - GRA DeepFlow Zones SNIPER
// Horizontal Limit Order Zones | STRICT: FVG + Single Prints
// SNIPER MODE: Only institutional-quality zones

//@version=6
indicator("DeepFlow Zones SNIPER", shorttitle="DFZğŸ¯", overlay=true, 
     max_boxes_count=100, max_lines_count=200, max_labels_count=100)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CONFIGURATION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

string GRP_SNIPER = "â•â•â•â•â•â•â•â•â•â•â• SNIPER FILTERS â•â•â•â•â•â•â•â•â•â•â•"
float minVolMultiplier = input.float(2.0, "Min Volume Multiplier", minval=1.5, maxval=4.0, step=0.1, group=GRP_SNIPER,
     tooltip="Zone creation requires 2x+ average volume")
float minGapATR = input.float(0.3, "Min Gap Size (ATR%)", minval=0.1, maxval=1.0, step=0.1, group=GRP_SNIPER,
     tooltip="FVG must be at least 30% of ATR")
float deltaDominance = input.float(0.60, "Delta Dominance %", minval=0.55, maxval=0.80, step=0.01, group=GRP_SNIPER,
     tooltip="60%+ buyer/seller dominance required")
float impulseMultiplier = input.float(1.8, "Impulse Range Multiplier", minval=1.5, maxval=3.0, step=0.1, group=GRP_SNIPER,
     tooltip="Impulse candle must be 1.8x average range")
float minBodyRatio = input.float(0.65, "Min Body Ratio", minval=0.5, maxval=0.85, step=0.05, group=GRP_SNIPER,
     tooltip="Body must be 65%+ of candle range")

string GRP_ZONES = "â•â•â•â•â•â•â•â•â•â•â• ZONE SETTINGS â•â•â•â•â•â•â•â•â•â•â•"
bool showZones = input.bool(true, "Show Limit Order Zones", group=GRP_ZONES)
bool showSinglePrintLines = input.bool(true, "Show Single Print Lines", group=GRP_ZONES)
int maxZoneAge = input.int(50, "Max Zone Age (bars)", minval=20, maxval=100, group=GRP_ZONES,
     tooltip="Zones expire after 50 bars")
int maxZones = input.int(10, "Max Active Zones", minval=3, maxval=20, group=GRP_ZONES,
     tooltip="Maximum 10 zones on chart")

string GRP_DELTA = "â•â•â•â•â•â•â•â•â•â•â• VOLUME DELTA â•â•â•â•â•â•â•â•â•â•â•"
string deltaTimeframe = input.timeframe("1", "Intrabar TF", group=GRP_DELTA)
int volPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group=GRP_DELTA)

string GRP_COLORS = "â•â•â•â•â•â•â•â•â•â•â• COLORS â•â•â•â•â•â•â•â•â•â•â•"
color bullZoneColor = input.color(color.new(#00E676, 80), "Bullish Zone", group=GRP_COLORS)
color bearZoneColor = input.color(color.new(#FF5252, 80), "Bearish Zone", group=GRP_COLORS)
color singlePrintColor = input.color(color.new(#FFD700, 20), "Single Print Lines", group=GRP_COLORS)
color entryLineColor = input.color(color.new(#FFFFFF, 40), "Entry Line (CE)", group=GRP_COLORS)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CORE CALCULATIONS  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

float avgVol = ta.sma(volume, volPeriod)
float avgRange = ta.sma(high - low, volPeriod)
float atr = ta.atr(14)
float volRatio = avgVol > 0 ? volume / avgVol : 1.0

float bodySize = math.abs(close - open)
float candleRange = high - low
float bodyRatioCalc = candleRange > 0 ? bodySize / candleRange : 0
bool isBullish = close > open
bool isBearish = close < open

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  SNIPER IMPULSE DETECTION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// STRICT Single Print = True institutional impulse
// Must have: Large range + Strong body + High volume
bool isImpulseRange = candleRange > avgRange * impulseMultiplier
bool isImpulseBody = bodyRatioCalc >= minBodyRatio
bool isImpulseVolume = volRatio >= minVolMultiplier

bool isSniperImpulse = isImpulseRange and isImpulseBody and isImpulseVolume

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  INTRABAR DELTA ANALYSIS  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float buyVol = 0.0
var float sellVol = 0.0
var float cvd = 0.0

if timeframe.isintraday
    [ltfO, ltfC, ltfV, ltfH, ltfL] = request.security_lower_tf(syminfo.tickerid, deltaTimeframe, [open, close, volume, high, low])
    
    if array.size(ltfC) > 0
        float tBuy = 0.0
        float tSell = 0.0
        
        for i = 0 to array.size(ltfC) - 1
            float r = array.get(ltfH, i) - array.get(ltfL, i)
            float c = array.get(ltfC, i)
            float o = array.get(ltfO, i)
            float v = array.get(ltfV, i)
            
            if r > 0
                float buyPctCalc = (c - array.get(ltfL, i)) / r
                tBuy += buyPctCalc * v
                tSell += (1 - buyPctCalc) * v
            else
                if c >= o
                    tBuy += v
                else
                    tSell += v
        
        buyVol := tBuy
        sellVol := tSell
    else
        float closePos = candleRange > 0 ? (close - low) / candleRange : 0.5
        buyVol := closePos * volume
        sellVol := (1 - closePos) * volume
else
    float closePos = candleRange > 0 ? (close - low) / candleRange : 0.5
    buyVol := closePos * volume
    sellVol := (1 - closePos) * volume

cvd := cvd + (buyVol - sellVol)

float totalVol = buyVol + sellVol
float buyPct = totalVol > 0 ? buyVol / totalVol : 0.5
float sellPct = totalVol > 0 ? sellVol / totalVol : 0.5

// STRICT delta dominance
bool buyDominant = buyPct >= deltaDominance
bool sellDominant = sellPct >= deltaDominance

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  SNIPER FVG ZONE DETECTION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// FVG = Fair Value Gap (imbalance zone)
bool fvgBullRaw = low > high[2]  // Gap up: current low above 2-bars-ago high
bool fvgBearRaw = high < low[2]  // Gap down: current high below 2-bars-ago low

// Calculate gap size
float bullGapSize = fvgBullRaw ? (low - high[2]) : 0
float bearGapSize = fvgBearRaw ? (low[2] - high) : 0

// SNIPER ZONE REQUIREMENTS:
// 1. FVG exists
// 2. Gap size is significant (30%+ of ATR)
// 3. Middle candle is impulse (1.8x range + 65% body + 2x volume)
// 4. Delta confirms direction (60%+ dominance)

bool gapSizeOK_Bull = bullGapSize >= atr * minGapATR
bool gapSizeOK_Bear = bearGapSize >= atr * minGapATR

bool impulseOK_Bull = candleRange[1] > avgRange * impulseMultiplier and 
                      (math.abs(close[1] - open[1]) / (high[1] - low[1])) >= minBodyRatio
bool impulseOK_Bear = candleRange[1] > avgRange * impulseMultiplier and 
                      (math.abs(close[1] - open[1]) / (high[1] - low[1])) >= minBodyRatio

bool volumeOK = volume[1] >= avgVol * minVolMultiplier

bool deltaOK_Bull = isBullish[1]  // Middle candle was bullish
bool deltaOK_Bear = isBearish[1]  // Middle candle was bearish

// SNIPER VALID ZONES
bool validBullZone = fvgBullRaw and gapSizeOK_Bull and impulseOK_Bull and volumeOK and deltaOK_Bull
bool validBearZone = fvgBearRaw and gapSizeOK_Bear and impulseOK_Bear and volumeOK and deltaOK_Bear

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE STORAGE (Arrays)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box[] zoneBoxes = array.new_box(0)
var line[] zoneLines = array.new_line(0)  // CE lines
var bool[] zoneBull = array.new_bool(0)
var float[] zoneTop = array.new_float(0)
var float[] zoneBottom = array.new_float(0)
var int[] zoneBar = array.new_int(0)
var int[] zoneState = array.new_int(0)  // 0=fresh, 1=tested, 2=filled

// Single Print Lines storage
var line[] spHighLines = array.new_line(0)
var line[] spLowLines = array.new_line(0)
var int[] spBars = array.new_int(0)
var bool[] spBull = array.new_bool(0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  CREATE NEW ZONES  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if showZones
    // Bullish Zone (buy zone below price)
    if validBullZone
        float topPrice = low
        float bottomPrice = high[2]
        float entry = (topPrice + bottomPrice) / 2
        
        // Horizontal box extending far right
        box zoneBox = box.new(bar_index[2], topPrice, bar_index + 500, bottomPrice,
             border_color=color.new(#00E676, 40), bgcolor=bullZoneColor, border_width=2)
        
        // CE entry line (50% level)
        line entryLine = line.new(bar_index[2], entry, bar_index + 500, entry,
             color=entryLineColor, style=line.style_dotted, width=1)
        
        array.push(zoneBoxes, zoneBox)
        array.push(zoneLines, entryLine)
        array.push(zoneBull, true)
        array.push(zoneTop, topPrice)
        array.push(zoneBottom, bottomPrice)
        array.push(zoneBar, bar_index)
        array.push(zoneState, 0)
    
    // Bearish Zone (sell zone above price)
    if validBearZone
        float topPrice = low[2]
        float bottomPrice = high
        float entry = (topPrice + bottomPrice) / 2
        
        // Horizontal box extending far right
        box zoneBox = box.new(bar_index[2], topPrice, bar_index + 500, bottomPrice,
             border_color=color.new(#FF5252, 40), bgcolor=bearZoneColor, border_width=2)
        
        // CE entry line (50% level)
        line entryLine = line.new(bar_index[2], entry, bar_index + 500, entry,
             color=entryLineColor, style=line.style_dotted, width=1)
        
        array.push(zoneBoxes, zoneBox)
        array.push(zoneLines, entryLine)
        array.push(zoneBull, false)
        array.push(zoneTop, topPrice)
        array.push(zoneBottom, bottomPrice)
        array.push(zoneBar, bar_index)
        array.push(zoneState, 0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  SINGLE PRINT LINES (SNIPER)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Only draw single print lines for TRUE institutional impulse candles
// Requires: Impulse + Volume + Delta confirmation
bool sniperSinglePrint = isSniperImpulse and ((isBullish and buyDominant) or (isBearish and sellDominant))

if showSinglePrintLines and sniperSinglePrint
    // Draw horizontal lines at high and low of single print candle
    line highLine = line.new(bar_index, high, bar_index + 500, high,
         color=singlePrintColor, style=line.style_solid, width=2)
    line lowLine = line.new(bar_index, low, bar_index + 500, low,
         color=singlePrintColor, style=line.style_solid, width=2)
    
    array.push(spHighLines, highLine)
    array.push(spLowLines, lowLine)
    array.push(spBars, bar_index)
    array.push(spBull, isBullish)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE STATE MANAGEMENT  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Update zone states and clean old zones
if array.size(zoneBoxes) > 0
    for i = array.size(zoneBoxes) - 1 to 0
        int age = bar_index - array.get(zoneBar, i)
        
        // Delete old zones
        if age > maxZoneAge
            box.delete(array.get(zoneBoxes, i))
            line.delete(array.get(zoneLines, i))
            array.remove(zoneBoxes, i)
            array.remove(zoneLines, i)
            array.remove(zoneBull, i)
            array.remove(zoneTop, i)
            array.remove(zoneBottom, i)
            array.remove(zoneBar, i)
            array.remove(zoneState, i)
            continue
        
        float top = array.get(zoneTop, i)
        float bot = array.get(zoneBottom, i)
        bool bull = array.get(zoneBull, i)
        int state = array.get(zoneState, i)
        
        // Check if zone is tested or filled
        if bull
            if state == 0 and low <= (top + bot) / 2
                array.set(zoneState, i, 1)  // Tested
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(#78909C, 80))
            if state < 2 and close < bot
                array.set(zoneState, i, 2)  // Filled/Broken
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(color.gray, 90))
                box.set_border_color(array.get(zoneBoxes, i), color.new(color.gray, 70))
        else
            if state == 0 and high >= (top + bot) / 2
                array.set(zoneState, i, 1)  // Tested
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(#78909C, 80))
            if state < 2 and close > top
                array.set(zoneState, i, 2)  // Filled/Broken
                box.set_bgcolor(array.get(zoneBoxes, i), color.new(color.gray, 90))
                box.set_border_color(array.get(zoneBoxes, i), color.new(color.gray, 70))

// Clean old single print lines
if array.size(spBars) > 0
    for i = array.size(spBars) - 1 to 0
        int age = bar_index - array.get(spBars, i)
        if age > maxZoneAge
            line.delete(array.get(spHighLines, i))
            line.delete(array.get(spLowLines, i))
            array.remove(spHighLines, i)
            array.remove(spLowLines, i)
            array.remove(spBars, i)
            array.remove(spBull, i)

// Garbage collection - limit zones
while array.size(zoneBoxes) > maxZones
    box.delete(array.get(zoneBoxes, 0))
    line.delete(array.get(zoneLines, 0))
    array.remove(zoneBoxes, 0)
    array.remove(zoneLines, 0)
    array.remove(zoneBull, 0)
    array.remove(zoneTop, 0)
    array.remove(zoneBottom, 0)
    array.remove(zoneBar, 0)
    array.remove(zoneState, 0)

// Limit single print lines
while array.size(spBars) > maxZones
    line.delete(array.get(spHighLines, 0))
    line.delete(array.get(spLowLines, 0))
    array.remove(spHighLines, 0)
    array.remove(spLowLines, 0)
    array.remove(spBars, 0)
    array.remove(spBull, 0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ZONE ENTRY DETECTION  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool atBullZone = false
var bool atBearZone = false
var int activeBullZones = 0
var int activeBearZones = 0

atBullZone := false
atBearZone := false
activeBullZones := 0
activeBearZones := 0

if array.size(zoneBoxes) > 0
    for i = 0 to array.size(zoneBoxes) - 1
        int state = array.get(zoneState, i)
        bool bull = array.get(zoneBull, i)
        
        // Count active zones
        if state < 2
            if bull
                activeBullZones += 1
            else
                activeBearZones += 1
        
        if state >= 2
            continue
        
        float top = array.get(zoneTop, i)
        float bot = array.get(zoneBottom, i)
        
        if bull and close >= bot and close <= top
            atBullZone := true
        if not bull and close >= bot and close <= top
            atBearZone := true

// SNIPER ENTRY: At zone + Delta confirms + Volume confirms
bool sniperBullEntry = atBullZone and buyDominant and volRatio >= 1.5
bool sniperBearEntry = atBearZone and sellDominant and volRatio >= 1.5

// Entry signals - SNIPER QUALITY ONLY
plotshape(sniperBullEntry, "ğŸ¯ Buy Zone", shape.labelup, location.belowbar, 
     color.new(#00E676, 0), text="BUYğŸ¯", textcolor=color.white, size=size.small)
plotshape(sniperBearEntry, "ğŸ¯ Sell Zone", shape.labeldown, location.abovebar, 
     color.new(#FF5252, 0), text="SELLğŸ¯", textcolor=color.white, size=size.small)

// Single print marker
plotshape(sniperSinglePrint and isBullish, "SP Bull", shape.diamond, location.belowbar, 
     color.new(#FFD700, 0), size=size.tiny, text="SP", textcolor=color.white)
plotshape(sniperSinglePrint and isBearish, "SP Bear", shape.diamond, location.abovebar, 
     color.new(#FFD700, 0), size=size.tiny, text="SP", textcolor=color.white)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  INFO TABLE  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table infoPanel = table.new(position.bottom_right, 2, 7, 
     bgcolor=color.new(#000000, 5), border_width=1, border_color=color.new(#333333, 0))

if barstate.islast
    // Header
    table.cell(infoPanel, 0, 0, "DFZ", text_color=color.white, text_size=size.small, bgcolor=color.new(#9C27B0, 30))
    table.cell(infoPanel, 1, 0, "ğŸ¯SNIPER", text_color=color.white, text_size=size.small, bgcolor=color.new(#9C27B0, 30))
    
    // Delta
    string deltaStr = buyPct > sellPct ? str.tostring(buyPct * 100, "#") + "%B" : str.tostring(sellPct * 100, "#") + "%S"
    color deltaCol = buyDominant ? color.new(#00E676, 0) : sellDominant ? color.new(#FF5252, 0) : color.white
    table.cell(infoPanel, 0, 1, "Delta", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 1, deltaStr, text_color=deltaCol, text_size=size.tiny)
    
    // Volume
    string volStr = str.tostring(volRatio, "#.#") + "x"
    color volCol = volRatio >= minVolMultiplier ? color.new(#00E676, 0) : color.white
    table.cell(infoPanel, 0, 2, "Vol", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 2, volStr, text_color=volCol, text_size=size.tiny)
    
    // Buy Zones
    table.cell(infoPanel, 0, 3, "Buy â¬š", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 3, str.tostring(activeBullZones), text_color=color.new(#00E676, 0), text_size=size.tiny)
    
    // Sell Zones
    table.cell(infoPanel, 0, 4, "Sell â¬š", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 4, str.tostring(activeBearZones), text_color=color.new(#FF5252, 0), text_size=size.tiny)
    
    // Zone Status
    string zoneStatus = atBullZone ? "AT BUY" : atBearZone ? "AT SELL" : "---"
    color zoneCol = atBullZone ? color.new(#00E676, 0) : atBearZone ? color.new(#FF5252, 0) : color.white
    table.cell(infoPanel, 0, 5, "Zone", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 5, zoneStatus, text_color=zoneCol, text_size=size.tiny)
    
    // Impulse status
    string impStr = isSniperImpulse ? "YES" : "---"
    color impCol = isSniperImpulse ? color.yellow : color.gray
    table.cell(infoPanel, 0, 6, "Impulse", text_color=color.white, text_size=size.tiny)
    table.cell(infoPanel, 1, 6, impStr, text_color=impCol, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ALERTS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(sniperBullEntry, title="ğŸ¯ BUY ZONE ENTRY", message="ğŸ¯ğŸŸ¢ SNIPER BUY ZONE {{ticker}} @ {{close}}")
alertcondition(sniperBearEntry, title="ğŸ¯ SELL ZONE ENTRY", message="ğŸ¯ğŸ”´ SNIPER SELL ZONE {{ticker}} @ {{close}}")
alertcondition(validBullZone, title="NEW BULL ZONE", message="ğŸŸ© NEW SNIPER BULLISH ZONE {{ticker}}")
alertcondition(validBearZone, title="NEW BEAR ZONE", message="ğŸŸ¥ NEW SNIPER BEARISH ZONE {{ticker}}")
alertcondition(sniperSinglePrint, title="ğŸ¯ SINGLE PRINT", message="â­ SNIPER SINGLE PRINT {{ticker}} @ {{close}}")

if sniperBullEntry
    alert("ğŸ¯ DFZ BUY | " + syminfo.ticker + " @ " + str.tostring(close, format.mintick) + " | Delta: " + str.tostring(buyPct * 100, "#") + "%B | Vol: " + str.tostring(volRatio, "#.#") + "x", alert.freq_once_per_bar_close)

if sniperBearEntry
    alert("ğŸ¯ DFZ SELL | " + syminfo.ticker + " @ " + str.tostring(close, format.mintick) + " | Delta: " + str.tostring(sellPct * 100, "#") + "%S | Vol: " + str.tostring(volRatio, "#.#") + "x", alert.freq_once_per_bar_close)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  END OF INDICATOR  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
